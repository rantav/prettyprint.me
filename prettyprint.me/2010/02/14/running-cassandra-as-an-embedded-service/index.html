<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<title>Running Cassandra as an embedded service | PrettyPrint.me</title>
<meta name="generator" content="WordPress 3.2" /> <!-- leave this for stats -->
<link rel="alternate" type="application/rss+xml" title="PrettyPrint.me RSS Feed" href="../../../../feed/index.html" />
<link rel="pingback" href="../../../../xmlrpc.php" />
<link rel="stylesheet" type="text/css" media="all" href="../../../../wp-content/themes/retrospective/style.css" />
<!--[if lte IE 7]>
	<link rel="stylesheet" type="text/css" media="all" href="http://prettyprint.me/wp-content/themes/retrospective/ie.css" />
<![endif]-->
<!--[if lte IE 6]>
	<link rel="stylesheet" type="text/css" media="all" href="http://prettyprint.me/wp-content/themes/retrospective/ie6.css" />
<![endif]--> 
<meta name="verify-v1" content="iFkC+FAFtOQ601MZ4pU4juKjv2UEYbdQNeezoVgCUyE=" >
<link rel="alternate" type="application/rss+xml" title="PrettyPrint.me &raquo; Running Cassandra as an embedded service Comments Feed" href="feed/index.html" />
<link rel='stylesheet' id='contact-form-7-css'  href='../../../../wp-content/plugins/contact-form-7/styles747d.css?ver=2.4.5' type='text/css' media='all' />
<script type='text/javascript' src='../../../../wp-includes/js/l10na17a.js?ver=20101110'></script>
<script type='text/javascript' src='../../../../wp-includes/js/jquery/jquery51a2.js?ver=1.6.1'></script>
<script type='text/javascript' src='../../../../wp-content/plugins/google-analyticator/external-tracking.min6fb3.js?ver=6.1.3'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../../../xmlrpc0db0.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../../../wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='PrettyPrint.me' href='../../../../index.html' />
<link rel='start' title='Hello Pretty World' href='../../../../2009/05/17/hello-pretty-world/index.html' />
<link rel='prev' title='Introduction to NOSQL and cassandra, part 2' href='../../../01/20/introduction-to-nosql-and-cassandra-part-2/index.html' />
<link rel='next' title='Hector &#8211; a Java Cassandra client' href='../../23/hector-a-java-cassandra-client/index.html' />
<meta name="generator" content="WordPress 3.2" />
<link rel='shortlink' href='../../../../index0c93.html?p=255' />

<!-- All in One SEO Pack 1.6.13.3 by Michael Torbert of Semper Fi Web Design[209,258] -->
<meta name="description" content="While developing an application at outbrain, using Cassandra I was looking for a good way to test my app. The application consists of a Cassandra Client" />
<link rel="canonical" href="index.html" />
<!-- /all in one seo pack -->
<meta name="tweetmeme-title" content="Running Cassandra as an embedded service" />
<link rel="stylesheet" href="../../../../wp-content/plugins/wp-syntax/wp-syntax.css" type="text/css" media="screen" />
<!-- Google Analytics Tracking by Google Analyticator 6.1.3: http://ronaldheft.com/code/analyticator/ -->
<script type="text/javascript">
	var analyticsFileTypes = [''];
	var analyticsEventTracking = 'enabled';
</script>
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-2694026-6']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</head>

<body>
<div id="header">
<a href="../../../../index.html" title="PrettyPrint.me">
<div id="logo">
<p>by Ran Tavory</p>
</div>
</a>
<div id="top_navlist">
<ul id="navlist">
<li class="page_item page-item-213"><a href="../../../../about-2/index.html" title="About.me">About.me</a></li>
<li class="page_item page-item-368"><a href="../../../../contact/index.html" title="Contact">Contact</a></li>
</ul>
</div><!--//top_navlist-->
</div><!--//header-->

<div id="container"><!--container -->
<!-- #content -->
<div id="content">

    <div class="post" id="post-255">
      <h1>Running Cassandra as an embedded service</h1>
      <p class="postmetadata"> </p>
      
      <div class="entry">
        <div class="tweetmeme_button" style="float: right; margin-left: 10px;"><a class="tm_button" rel="&amp;style=normal&amp;b=2" href="index.html"></a></div>
<p><a href="../../../../wp-content/uploads/2010/02/cassandra3125.jpg"><img class="size-medium wp-image-257 alignleft" title="cassandra embedded" src="../../../../wp-content/uploads/2010/02/cassandra3125-220x300.jpg" alt="" width="220" height="300" /></a>While developing an application at outbrain, using <a href="http://incubator.apache.org/cassandra/">Cassandra</a> I was looking for a good way to test my app. The application consists of a Cassandra Client package, some Data Access Objects (DAOs) and some bean object that represent the data entities in cassandra. I wanted to test them all.</p>
<p>As unit test tradition goes, my requirement was zero-configuration, zero preparation, no external dependencies, full isolation, fully reproducible results and fast. Database testing has always been a challenge in this perspective, for example when testing SQL clients in java often <a href="http://hsqldb.org/">HSQLDB</a> is used to to mock the database. Cassandra, however, did not have something ready just yet so I had to build it.</p>
<p>One way to go was to setup a cassandra instance just for unit testing. There are many downsides to this approach, such as it&#8217;s not zero-configuration, tests need to cleanup before they execute, if two tests are run at the same time by two developers they can collide and change the results in unexpected way, it&#8217;s slow&#8230; out of the question, not good.</p>
<p>Enter the embedded cassandra server.</p>
<p>With the help of the community I&#8217;ve built an embedded cassandra service ideal for unit testing and perhaps other uses. I&#8217;ve also built a cleanup utility that helps wipe out all data before the service starts running so the combination of both provides isolation etc. Now each test process runs an in-process, embedded instance of cassandra.</p>
<p>Below is the source code, already committed to cassandra SCM on trunk. If you want to use it for the current stable release(0.5.0) only a small package rename is required (in trunk some classes moved a bit), and it&#8217;s presented at the end of the post.</p>
<p>The embedded service:</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">package</span> <span style="color: #006699;">org.apache.cassandra.service</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.io.File</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.io.FileOutputStream</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.io.IOException</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.io.InputStream</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.io.OutputStream</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.config.DatabaseDescriptor</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.io.util.FileUtils</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.thrift.CassandraDaemon</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.thrift.transport.TTransportException</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.slf4j.Logger</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.slf4j.LoggerFactory</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #008000; font-style: italic; font-weight: bold;">/**
 * An embedded, in-memory cassandra storage service that listens
 * on the thrift interface as configured in storage-conf.xml
 * This kind of service is useful when running unit tests of
 * services using cassandra for example.
 *
&nbsp;
 * This is the implementation of https://issues.apache.org/jira/browse/CASSANDRA-740
 *
&nbsp;
 * How to use:
 * In the client code create a new thread and spawn it with its {@link Thread#start()} method.
 * Example:
 *
 *      // Tell cassandra where the configuration files are.
        System.setProperty(&quot;storage-config&quot;, &quot;conf&quot;);
&nbsp;
        cassandra = new EmbeddedCassandraService();
        cassandra.init();
&nbsp;
        // spawn cassandra in a new thread
        Thread t = new Thread(cassandra);
        t.setDaemon(true);
        t.start();
&nbsp;
 *
 * @author Ran Tavory (rantav@gmail.com)
 *
 */</span>
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> EmbeddedCassandraService <span style="color: #000000; font-weight: bold;">implements</span> <span style="color: #003399;">Runnable</span>
<span style="color: #009900;">&#123;</span>
&nbsp;
    CassandraDaemon cassandraDaemon<span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> init<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> TTransportException, <span style="color: #003399;">IOException</span>
    <span style="color: #009900;">&#123;</span>
        cassandraDaemon <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> CassandraDaemon<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        cassandraDaemon.<span style="color: #006633;">init</span><span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> run<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
    <span style="color: #009900;">&#123;</span>
        cassandraDaemon.<span style="color: #006633;">start</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>The data cleaner:</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">package</span> <span style="color: #006699;">org.apache.cassandra.contrib.utils.service</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.io.File</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.io.IOException</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.util.HashSet</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.util.Set</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.config.DatabaseDescriptor</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.io.util.FileUtils</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #008000; font-style: italic; font-weight: bold;">/**
 * A cleanup utility that wipes the cassandra data directories.
 *
 * @author Ran Tavory (rantav@gmail.com)
 *
 */</span>
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CassandraServiceDataCleaner <span style="color: #009900;">&#123;</span>
&nbsp;
    <span style="color: #008000; font-style: italic; font-weight: bold;">/**
     * Creates all data dir if they don't exist and cleans them
     * @throws IOException
     */</span>
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> prepare<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">IOException</span> <span style="color: #009900;">&#123;</span>
        makeDirsIfNotExist<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        cleanupDataDirectories<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #008000; font-style: italic; font-weight: bold;">/**
     * Deletes all data from cassandra data directories, including the commit log.
     * @throws IOException in case of permissions error etc.
     */</span>
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> cleanupDataDirectories<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">IOException</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #000000; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> s<span style="color: #339933;">:</span> getDataDirs<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
            cleanDir<span style="color: #009900;">&#40;</span>s<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #008000; font-style: italic; font-weight: bold;">/**
     * Creates the data diurectories, if they didn't exist.
     * @throws IOException if directories cannot be created (permissions etc).
     */</span>
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> makeDirsIfNotExist<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">IOException</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #000000; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> s<span style="color: #339933;">:</span> getDataDirs<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
            mkdir<span style="color: #009900;">&#40;</span>s<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #008000; font-style: italic; font-weight: bold;">/**
     * Collects all data dirs and returns a set of String paths on the file system.
     *
     * @return
     */</span>
    <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Set</span> getDataDirs<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #003399;">Set</span> dirs <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">HashSet</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> s <span style="color: #339933;">:</span> DatabaseDescriptor.<span style="color: #006633;">getAllDataFileLocations</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
            dirs.<span style="color: #006633;">add</span><span style="color: #009900;">&#40;</span>s<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
        dirs.<span style="color: #006633;">add</span><span style="color: #009900;">&#40;</span>DatabaseDescriptor.<span style="color: #006633;">getLogFileLocation</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">return</span> dirs<span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #008000; font-style: italic; font-weight: bold;">/**
     * Creates a directory
     *
     * @param dir
     * @throws IOException
     */</span>
    <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000066; font-weight: bold;">void</span> mkdir<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> dir<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">IOException</span> <span style="color: #009900;">&#123;</span>
        FileUtils.<span style="color: #006633;">createDirectory</span><span style="color: #009900;">&#40;</span>dir<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #008000; font-style: italic; font-weight: bold;">/**
     * Removes all directory content from file the system
     *
     * @param dir
     * @throws IOException
     */</span>
    <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000066; font-weight: bold;">void</span> cleanDir<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> dir<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">IOException</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #003399;">File</span> dirFile <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">File</span><span style="color: #009900;">&#40;</span>dir<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>dirFile.<span style="color: #006633;">exists</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">&amp;</span>amp<span style="color: #339933;">;&amp;</span>amp<span style="color: #339933;">;</span> dirFile.<span style="color: #006633;">isDirectory</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
            FileUtils.<span style="color: #006633;">delete</span><span style="color: #009900;">&#40;</span>dirFile.<span style="color: #006633;">listFiles</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>And an example test that uses both:</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">package</span> <span style="color: #006699;">org.apache.cassandra.contrib.utils.service</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">static</span> org.<span style="color: #006633;">junit</span>.<span style="color: #000000; font-weight: bold;">Assert</span>.<span style="color: #006633;">assertEquals</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">static</span> org.<span style="color: #006633;">junit</span>.<span style="color: #000000; font-weight: bold;">Assert</span>.<span style="color: #006633;">assertNotNull</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.io.IOException</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.io.UnsupportedEncodingException</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.service.EmbeddedCassandraService</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.thrift.Cassandra</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.thrift.ColumnOrSuperColumn</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.thrift.ColumnPath</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.thrift.ConsistencyLevel</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.thrift.InvalidRequestException</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.thrift.NotFoundException</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.thrift.TimedOutException</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.cassandra.thrift.UnavailableException</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.thrift.TException</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.thrift.protocol.TBinaryProtocol</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.thrift.protocol.TProtocol</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.thrift.transport.TSocket</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.thrift.transport.TTransport</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.thrift.transport.TTransportException</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.junit.BeforeClass</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.junit.Test</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #008000; font-style: italic; font-weight: bold;">/**
 * Example how to use an embedded and a data cleaner.
 *
 * @author Ran Tavory (rantav@gmail.com)
 *
 */</span>
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CassandraServiceTest <span style="color: #009900;">&#123;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">static</span> EmbeddedCassandraService cassandra<span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #008000; font-style: italic; font-weight: bold;">/**
     * Set embedded cassandra up and spawn it in a new thread.
     *
     * @throws TTransportException
     * @throws IOException
     * @throws InterruptedException
     */</span>
    @BeforeClass
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000066; font-weight: bold;">void</span> setup<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> TTransportException, <span style="color: #003399;">IOException</span>,
            <span style="color: #003399;">InterruptedException</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #666666; font-style: italic;">// Tell cassandra where the configuration files are.</span>
        <span style="color: #666666; font-style: italic;">// Use the test configuration file.</span>
        <span style="color: #003399;">System</span>.<span style="color: #006633;">setProperty</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;storage-config&quot;</span>, <span style="color: #0000ff;">&quot;../../test/conf&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
        CassandraServiceDataCleaner cleaner <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> CassandraServiceDataCleaner<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        cleaner.<span style="color: #006633;">prepare</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        cassandra <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> EmbeddedCassandraService<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        cassandra.<span style="color: #006633;">init</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #003399;">Thread</span> t <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">Thread</span><span style="color: #009900;">&#40;</span>cassandra<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        t.<span style="color: #006633;">setDaemon</span><span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">true</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        t.<span style="color: #006633;">start</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>   
&nbsp;
    @Test
    <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> testInProcessCassandraServer<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>
            <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">UnsupportedEncodingException</span>, InvalidRequestException,
            UnavailableException, TimedOutException, TException,
            NotFoundException <span style="color: #009900;">&#123;</span>
        Cassandra.<span style="color: #006633;">Client</span> client <span style="color: #339933;">=</span> getClient<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
        <span style="color: #003399;">String</span> key_user_id <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;1&quot;</span><span style="color: #339933;">;</span>
&nbsp;
        <span style="color: #000066; font-weight: bold;">long</span> timestamp <span style="color: #339933;">=</span> <span style="color: #003399;">System</span>.<span style="color: #006633;">currentTimeMillis</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        ColumnPath cp <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> ColumnPath<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Standard1&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        cp.<span style="color: #006633;">setColumn</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;name&quot;</span>.<span style="color: #006633;">getBytes</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;utf-8&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
        <span style="color: #666666; font-style: italic;">// insert</span>
        client.<span style="color: #006633;">insert</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Keyspace1&quot;</span>, key_user_id, cp, <span style="color: #0000ff;">&quot;Ran&quot;</span>.<span style="color: #006633;">getBytes</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;UTF-8&quot;</span><span style="color: #009900;">&#41;</span>,
                timestamp, ConsistencyLevel.<span style="color: #006633;">ONE</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
        <span style="color: #666666; font-style: italic;">// read</span>
        ColumnOrSuperColumn got <span style="color: #339933;">=</span> client.<span style="color: #006633;">get</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Keyspace1&quot;</span>, key_user_id, cp,
                ConsistencyLevel.<span style="color: #006633;">ONE</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
        <span style="color: #666666; font-style: italic;">// assert</span>
        assertNotNull<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Got a null ColumnOrSuperColumn&quot;</span>, got<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        assertEquals<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Ran&quot;</span>, <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">String</span><span style="color: #009900;">&#40;</span>got.<span style="color: #006633;">getColumn</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">getValue</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>, <span style="color: #0000ff;">&quot;utf-8&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #008000; font-style: italic; font-weight: bold;">/**
     * Gets a connection to the localhost client
     *
     * @return
     * @throws TTransportException
     */</span>
    <span style="color: #000000; font-weight: bold;">private</span> Cassandra.<span style="color: #006633;">Client</span> getClient<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> TTransportException <span style="color: #009900;">&#123;</span>
        TTransport tr <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> TSocket<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;localhost&quot;</span>, <span style="color: #cc66cc;">9170</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        TProtocol proto <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> TBinaryProtocol<span style="color: #009900;">&#40;</span>tr<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        Cassandra.<span style="color: #006633;">Client</span> client <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> Cassandra.<span style="color: #006633;">Client</span><span style="color: #009900;">&#40;</span>proto<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        tr.<span style="color: #006633;">open</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">return</span> client<span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>To use this source code in v0.5.0 a small package rename is required:<br />
org.apache.cassandra.io.util.FileUtils =&gt; org.apache.cassandra.utils.FileUtils<br />
org.apache.thrift.transport.TTransportException =&gt; org.apache.transport.TTransportException<br />
org.apache.cassandra.thrift.CassandraDaemon =&gt; org.apache.cassandra.CassandraDaemon</p>
<p>One nifty detail: When running multiple tests serially, make sure to spawn each test in a separate JVM (fork mode) since cassandra doesn&#8217;t shut down all threads immediately. Running each in separate jvm ensures the previous test dies before the next one begins.</p>
<script type='text/javascript'>
		<!--
		//OBSTART:do_NOT_remove_this_comment
		var OutbrainPermaLink="index.html";
		if(typeof(OB_Script)!='undefined'){OutbrainStart();} else {
		var OB_PlugInVer="7.0.0.0_Regular";;var OB_raterMode="stars";var OB_recMode="rec";var OBITm="1263219542";var OB_Script=true;var OB_langJS="";document.write(unescape("%3Cscript src='http://widgets.outbrain.com/OutbrainRater.js' type='text/javascript'%3E%3C/script%3E"));}
		//OBEND:do_NOT_remove_this_comment
		//-->
		</script>
		      </div>
      <p class="postmetadata2">Published in <a href="../../../../category/uncategorized/index.html" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a><!-- by <php the_author(); ?> -->, February 14th, 2010 <br />
      	</p>
    </div>
    
	<!--
	<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
			xmlns:dc="http://purl.org/dc/elements/1.1/"
			xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/">
		<rdf:Description rdf:about="http://prettyprint.me/2010/02/14/running-cassandra-as-an-embedded-service/"
    dc:identifier="http://prettyprint.me/2010/02/14/running-cassandra-as-an-embedded-service/"
    dc:title="Running Cassandra as an embedded service"
    trackback:ping="http://prettyprint.me/2010/02/14/running-cassandra-as-an-embedded-service/trackback/" />
</rdf:RDF>	-->

  
<!-- You can start editing here. -->

<div class="boxcomments">




	<h2 id="comments">20 Responses to &#8220;Running Cassandra as an embedded service&#8221;</h2>

	<ol class="commentlist">
	
			
<li class="odd" id="comment-346">

			
        <p>Sweet! Just what the doctor ordered.</p>
        
        <img alt='' src='http://0.gravatar.com/avatar/46598cebb1e1d5c4237bc36d8d47ae80?s=28&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong>drtune</strong> on <a href="#comment-346" title="">Mar 3, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="odd" id="comment-399">

			
        <p>good stuff!</p>
        
        <img alt='' src='http://1.gravatar.com/avatar/fca8a21722c60e977b2075a1afa87fc7?s=28&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong>arnon</strong> on <a href="#comment-399" title="">Mar 16, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="odd" id="comment-424">

			
        <p>Hi, could you suggest how to configure it to start the daemon per test?<br />
I keep on seeing NullPointerException at<br />
org.apache.cassandra.db.ColumnFamilyStore.onStart(line:191).</p>
<p>Good stuff.<br />
thanks!</p>
        
        <img alt='' src='http://1.gravatar.com/avatar/5b4123fdaaef44abe5cc1f33304444bc?s=28&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong>Patricio</strong> on <a href="#comment-424" title="">Mar 19, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="mycomment" id="comment-427">

			
        <p>I actually use it in another project, see here <a href="http://github.com/rantav/hector/blob/master/src/test/java/me/prettyprint/cassandra/service/KeyspaceTest.java#L81" rel="nofollow">http://github.com/rantav/hector/blob/master/src/test/java/me/prettyprint/cassandra/service/KeyspaceTest.java#L81</a></p>
        
        <img alt='' src='http://0.gravatar.com/avatar/2cdc5c3059c40c76d5ca7bec8d149f9e?s=28&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong>Ran Tavory</strong> on <a href="#comment-427" title="">Mar 19, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="odd" id="comment-505">

			
        <p>Hi Ran!</p>
<p> I was trying to achieve something similar but I went thru a completely different path&#8230; I tried to reproduce what CassandraDaemon does but with a in memory TTransport that I implemented. Unfortunately it did not work as I expected (at least up to now). Have you seen anything on the internet about using a different (something like a in memory) TTransport? I was thinking about having Cassandra daemon embedded in the application so in case my application was running in a J2EE cluster, each clustered instance would have its own Cassandra Service builtin.</p>
<p>regards,<br />
Rafael Ribeiro</p>
        
        <img alt='' src='http://0.gravatar.com/avatar/292a48d9cbe4c198ce280095a4e3fecc?s=28&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong><a href='http://itdevworld.wordpress.com/' rel='external nofollow' class='url'>Rafael Ribeiro</a></strong> on <a href="#comment-505" title="">Apr 1, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="mycomment" id="comment-506">

			
        <p>There used to be something called cassandra &#8220;fat client&#8221; which may be what you&#8217;re looking for, I&#8217;m not sure (google it&#8230;)<br />
But the thing is that it hasn&#8217;t been maintained lately and I think I read a few days ago in the mailing list that it&#8217;s been taken off the wiki for not being up to date.<br />
Anyhow, google it and read about it, then your best bet is to email user@cassandra&#8230; and ask.<br />
My motivation for creating the embedded service was unit testing, so I wanted an environment as close as possible to a real instance running. I used it in the client I wrote <a href="http://github.com/rantav/hector" rel="nofollow">http://github.com/rantav/hector</a></p>
        
        <img alt='' src='http://0.gravatar.com/avatar/2cdc5c3059c40c76d5ca7bec8d149f9e?s=28&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong>Ran Tavory</strong> on <a href="#comment-506" title="">Apr 1, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="odd" id="comment-507">

			
        <p>Hi Ran!</p>
<p> Errh&#8230; I should have googled it before I tried to implement my own in memory TTransport&#8230; in fact there is already documentation over Cassandra Wiki explaining how to do this:<br />
<a href="http://wiki.apache.org/cassandra/StorageProxy" rel="nofollow">http://wiki.apache.org/cassandra/StorageProxy</a><br />
<a href="http://wiki.apache.org/cassandra/Embedding" rel="nofollow">http://wiki.apache.org/cassandra/Embedding</a></p>
<p>anyways&#8230; tks a lot!</p>
        
        <img alt='' src='http://0.gravatar.com/avatar/292a48d9cbe4c198ce280095a4e3fecc?s=28&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong><a href='http://itdevworld.wordpress.com/' rel='external nofollow' class='url'>Rafael Ribeiro</a></strong> on <a href="#comment-507" title="">Apr 1, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="odd" id="comment-564">

			
        <p>Hi Ran,</p>
<p>This is really a good stuff, and I am looking for such things for unit test. But I am wondering how do you kill the embedded-cassandra server. Seems your code does not do such things.</p>
        
        <img alt='' src='http://1.gravatar.com/avatar/dd3b1dec4a32f39e9c1faa7362c18710?s=28&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong>Jeff Zhang</strong> on <a href="#comment-564" title="">Apr 13, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="mycomment" id="comment-565">

			
        <p>There&#8217;s a limitation in cassandra that it cannot be killed&#8230;<br />
Actually it can, but only by stopping the jvm. I know, it sucks, but that&#8217;s what cassandra can provide now&#8230;<br />
For tests, using fork mode bypasses this problem since each individual test runs in its own jvm</p>
        
        <img alt='' src='http://0.gravatar.com/avatar/2cdc5c3059c40c76d5ca7bec8d149f9e?s=28&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong>Ran Tavory</strong> on <a href="#comment-565" title="">Apr 13, 2010</a> </p>
        	
        
	</li>
		
		
					
<li class="odd" id="comment-2845">

			
        <p>Is there a solution for the shutdown problem? One that does not require me to kill the JVM?</p>
        
        <img alt='' src='http://1.gravatar.com/avatar/7ac1b4fe3c648f35d3c552f214d6d3da?s=28&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong><a href='http://zepan.org/' rel='external nofollow' class='url'>Michael Zehrer</a></strong> on <a href="#comment-2845" title="">Aug 2, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="mycomment" id="comment-2849">

			
        <p>no, that&#8217;s a design limitation in cassandra</p>
        
        <img alt='' src='http://0.gravatar.com/avatar/2cdc5c3059c40c76d5ca7bec8d149f9e?s=28&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong>Ran Tavory</strong> on <a href="#comment-2849" title="">Aug 2, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="odd" id="comment-3298">

			
        <p>Thanks for putting up this embedded server, very helpful<br />
Any ideas why this is a cassandra design limitation ?</p>
        
        <img alt='' src='http://0.gravatar.com/avatar/0d11e8dbff307e1ddbf0578dcbf177f9?s=28&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong>Kannan</strong> on <a href="#comment-3298" title="">Sep 9, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="mycomment" id="comment-3308">

			
        <p>you mean why it cannot be killed? it&#8217;s been discussed at user@cassandra a few times. Basically it&#8217;s a design decision and was never considered important enough to rethink it</p>
        
        <img alt='' src='http://0.gravatar.com/avatar/2cdc5c3059c40c76d5ca7bec8d149f9e?s=28&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong>Ran Tavory</strong> on <a href="#comment-3308" title="">Sep 9, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="odd" id="comment-3318">

			
        <p>Thanks for the reply. I notice that if I kill the jvm and the memtable is not full yet, its not flushing the in-memory data to disk. Any ideas how to get around this ? Currently I am using something like this:</p>
<p>for(String t: DatabaseDescriptor.getTables()) {<br />
  Table table = Table.open(t);<br />
  for(ColumnFamilyStore cfs: table.getColumnFamilyStores()) {<br />
	cfs.forceBlockingFlush();<br />
 }<br />
}</p>
<p>Do you see any problems with this? Is there a better way to do it ?</p>
<p>Thanks again</p>
        
        <img alt='' src='http://0.gravatar.com/avatar/0d11e8dbff307e1ddbf0578dcbf177f9?s=28&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong>Kannan</strong> on <a href="#comment-3318" title="">Sep 10, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="mycomment" id="comment-3323">

			
        <p>@Kannan if memtables aren&#8217;t flushed then cassandra will read the commit log when it starts up next time so data isn&#8217;t lost.<br />
Per your code, I&#8217;m now too far away from the latest on trunk so it&#8217;s best to advice with dev@cassandra</p>
        
        <img alt='' src='http://0.gravatar.com/avatar/2cdc5c3059c40c76d5ca7bec8d149f9e?s=28&amp;d=http%3A%2F%2F0.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong>Ran Tavory</strong> on <a href="#comment-3323" title="">Sep 10, 2010</a> </p>
        	
        
	</li>
		
		
		
<li class="odd" id="comment-4252">

			
        <p>0.7.0 has some differences i&#8217;ve found.</p>
<p>Instead of<br />
 System.setProperty(&#8220;storage-config&#8221;, &#8220;../../test/conf&#8221;);<br />
you&#8217;ll need (because of the change to yaml)<br />
 System.setProperty(&#8220;cassandra.config&#8221;, &#8220;../../test/conf/cassandra.yaml&#8221;);</p>
<p>Also if the property value is an absolute filepath it needs to be in URL format, see DatabaseDescriptor.getStorageConfigURL()</p>
        
        <img alt='' src='http://1.gravatar.com/avatar/175cfce69cc08447cea401df2fcaf89a?s=28&amp;d=http%3A%2F%2F1.gravatar.com%2Favatar%2Fad516503a11cd5ca435acc9bb6523536%3Fs%3D28&amp;r=G' class='avatar avatar-28 photo' height='28' width='28' />        
        <p style="margin-bottom:5px;">By <strong><a href='http://semb.wever.org/' rel='external nofollow' class='url'>mck</a></strong> on <a href="#comment-4252" title="">Nov 12, 2010</a> </p>
        	
        
	</li>
		
		
		
	</ol>
	
	

	<h2 id="trackbacks">4 Trackback(s)</h2>
	
	<ol class="tblist">
	

	<li id="comment-270">
		Feb 23, 2010: <a href='http://www.ubervu.com/conversations/prettyprint.me/2010/02/14/running-cassandra-as-an-embedded-service/' rel='external nofollow' class='url'>uberVU - social comments</a>			</li>
	
		

	<li id="comment-732">
		Apr 27, 2010: <a href='http://danielharrison.wordpress.com/2010/04/27/links-for-2010-04-26/' rel='external nofollow' class='url'>links for 2010-04-26 &laquo; Daniel Harrison&#39;s Personal Blog</a>			</li>
	
		

	<li id="comment-797">
		May 2, 2010: <a href='../../../05/02/understanding-cassandra-code-base/index.html' rel='external nofollow' class='url'>Understanding Cassandra Code Base | PrettyPrint.me</a>			</li>
	
		

	<li id="comment-2810">
		Jul 30, 2010: <a href='https://wiki.globalrelay.net/display/TMA/Cassandra+Research+Links' rel='external nofollow' class='url'>Confluence: Team Message Archiver</a>			</li>
	
		

	</ol>

	

	<p id="comments-closed">Sorry, comments for this entry are closed at this time.</p>
</div>  
 
 
</div><!-- //content -->

<div id="sidebar"><!-- sidebar -->

<p class="rssfeed"><a class="rsslink" href="../../../../feed/index.html"></a>
<p><a href="http://feeds2.feedburner.com/PrettyPrintMe"><img src="http://feeds2.feedburner.com/~fc/PrettyPrintMe?bg=3069B0&amp;fg=fffdfa&amp;anim=1" height="26" width="88" style="border:0" alt="" /></a></p>
</p>

<h2>Search</h2>
<form method="get" id="searchform" class="search" action="http://prettyprint.me/">
<input type="text" name="s" value="Type keywords and hit enter..." onfocus="if (this.value == 'Type keywords and hit enter...') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Type keywords and hit enter...';}" />
</form>

<!--
<h2>Categories</h2>
<ul>
		<li class="cat-item cat-item-1"><a href="http://prettyprint.me/category/uncategorized/" title="View all posts filed under Uncategorized">Uncategorized</a>
</li>
</ul>
-->

<h2>Blog Archives</h2>
<ul>
  	<li><a href='../../../../2011/07/index.html' title='July 2011'>July 2011</a></li>
	<li><a href='../../../../2011/02/index.html' title='February 2011'>February 2011</a></li>
	<li><a href='../../../../2011/01/index.html' title='January 2011'>January 2011</a></li>
	<li><a href='../../../08/index.html' title='August 2010'>August 2010</a></li>
	<li><a href='../../../05/index.html' title='May 2010'>May 2010</a></li>
	<li><a href='../../../04/index.html' title='April 2010'>April 2010</a></li>
	<li><a href='../../../03/index.html' title='March 2010'>March 2010</a></li>
	<li><a href='../../index.html' title='February 2010'>February 2010</a></li>
	<li><a href='../../../01/index.html' title='January 2010'>January 2010</a></li>
	<li><a href='../../../../2009/11/index.html' title='November 2009'>November 2009</a></li>
	<li><a href='../../../../2009/10/index.html' title='October 2009'>October 2009</a></li>
	<li><a href='../../../../2009/09/index.html' title='September 2009'>September 2009</a></li>
	<li><a href='../../../../2009/08/index.html' title='August 2009'>August 2009</a></li>
	<li><a href='../../../../2009/06/index.html' title='June 2009'>June 2009</a></li>
	<li><a href='../../../../2009/05/index.html' title='May 2009'>May 2009</a></li>
</ul>

<!--
<h2>Links</h2>
<ul>
  <li><a href="http://wordpress.org/development/">Development Blog</a></li>
<li><a href="http://codex.wordpress.org/">Documentation</a></li>
<li><a href="http://wordpress.org/extend/plugins/">Plugins</a></li>
<li><a href="http://wordpress.org/extend/ideas/">Suggest Ideas</a></li>
<li><a href="http://wordpress.org/support/">Support Forum</a></li>
<li><a href="http://wordpress.org/extend/themes/">Themes</a></li>
<li><a href="http://planet.wordpress.org/">WordPress Planet</a></li>
</ul>
-->

<!--
<h2>Meta</h2>
<ul>
    <li><a href="http://prettyprint.me/wp-login.php">Log in</a></li>
  <li><a href="http://www.wordpress.org/">WordPress</a></li>
    <li><a href="http://validator.w3.org/check?uri=referer">XHTML</a></li>
</ul>
-->

 


</div> <!--//sidebar  -->

</div><!--//container-->

<div id="footer-container">
	
<div id="footer">

<div id="footerleft">
		<h2>About</h2>
  <p>Restrospective focuses on clean typography and modern colors and design.</p>
  </div>

<div id="footermid">
		<h2>Profiles, Links</h2>
	<ul>
  	<li><a href="http://www.linkedin.com/in/rantav">LinkedIn</a></li>
  	<li><a href="http://tavory.com/">Homepage</a></li>
  	<li><a href="http://twitter.com/rantav">Twitter</a></li>
  	<li><a href="http://reversim.com/">(Hebrew podcast I run) רברס עם פלטפורמה</a></li>
  	<li><a href="http://friendfeed.com/rantav">FriendFeed</a></li>
  	<li><a href="http://gbsheli.com/">Google Blog Sheli (my older blog, mostly Hebrew)</a></li>
  	<li><a href="http://www.facebook.com/people/Ran-Tavory/543122173">Facebook</a></li>
  </ul>
  </div>

<div id="footerright">
	<!--
	<h2>Recent Readers</h2>
-->
  <!--	Paste JavaScript from MyBlogLog or other services -->

  </div>

</div><!--//footer-->

<div class="copyright">
	Copyright &copy; <a href="../../../../index.html">PrettyPrint.me</a> &middot; All rights reserved.<br />
	
	Powered by <a href="http://wordpress.org/">WordPress</a> and <a href="http://blogbuildingu.com/retrospective">Retrospective theme</a> &middot; Design & code by <a href="http://blogbuildingu.com/">Hendry Lee</a>.

<script type='text/javascript' src='../../../../wp-content/plugins/contact-form-7/jquery.formd20f.js?ver=2.52'></script>
<script type='text/javascript' src='../../../../wp-content/plugins/contact-form-7/scripts747d.js?ver=2.4.5'></script>
<script src="../../../../wp-content/plugins/tweetmeme/button.js" type="text/javascript"></script></div>

</div><!--//footer-container-->

</body>

<!-- Mirrored from prettyprint.me/2010/02/14/running-cassandra-as-an-embedded-service/ by HTTrack Website Copier/3.x [XR&CO'2010], Fri, 28 Dec 2012 23:00:54 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
</html>
