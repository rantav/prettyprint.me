<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<title>PrettyPrint.me - Part 2</title>
<meta name="generator" content="WordPress 3.2" /> <!-- leave this for stats -->
<link rel="alternate" type="application/rss+xml" title="PrettyPrint.me RSS Feed" href="../../feed/index.html" />
<link rel="pingback" href="../../xmlrpc.php" />
<link rel="stylesheet" type="text/css" media="all" href="../../wp-content/themes/retrospective/style.css" />
<!--[if lte IE 7]>
	<link rel="stylesheet" type="text/css" media="all" href="http://prettyprint.me/wp-content/themes/retrospective/ie.css" />
<![endif]-->
<!--[if lte IE 6]>
	<link rel="stylesheet" type="text/css" media="all" href="http://prettyprint.me/wp-content/themes/retrospective/ie6.css" />
<![endif]--> 
<meta name="verify-v1" content="iFkC+FAFtOQ601MZ4pU4juKjv2UEYbdQNeezoVgCUyE=" >
<link rel='stylesheet' id='contact-form-7-css'  href='../../wp-content/plugins/contact-form-7/styles747d.css?ver=2.4.5' type='text/css' media='all' />
<script type='text/javascript' src='../../wp-includes/js/l10na17a.js?ver=20101110'></script>
<script type='text/javascript' src='../../wp-includes/js/jquery/jquery51a2.js?ver=1.6.1'></script>
<script type='text/javascript' src='../../wp-content/plugins/google-analyticator/external-tracking.min6fb3.js?ver=6.1.3'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../xmlrpc0db0.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='PrettyPrint.me' href='../../index.html' />
<meta name="generator" content="WordPress 3.2" />

<!-- All in One SEO Pack 1.6.13.3 by Michael Torbert of Semper Fi Web Design[209,230] -->
<link rel="canonical" href="index.html" />
<!-- /all in one seo pack -->

<link rel="stylesheet" href="../../wp-content/plugins/wp-syntax/wp-syntax.css" type="text/css" media="screen" />
<!-- Google Analytics Tracking by Google Analyticator 6.1.3: http://ronaldheft.com/code/analyticator/ -->
<script type="text/javascript">
	var analyticsFileTypes = [''];
	var analyticsEventTracking = 'enabled';
</script>
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-2694026-6']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</head>

<body>
<div id="header">
<a href="../../index.html" title="PrettyPrint.me">
<div id="logo">
<p>by Ran Tavory</p>
</div>
</a>
<div id="top_navlist">
<ul id="navlist">
<li class="page_item page-item-213"><a href="../../about-2/index.html" title="About.me">About.me</a></li>
<li class="page_item page-item-368"><a href="../../contact/index.html" title="Contact">Contact</a></li>
</ul>
</div><!--//top_navlist-->
</div><!--//header-->

<div id="container"><!--container -->
<!-- #content -->
<div id="content">


      <div class="post" id="post-241">
      <h1><a href="../../2010/01/20/introduction-to-nosql-and-cassandra-part-2/index.html" rel="bookmark" title="Permalink to Introduction to NOSQL and cassandra, part 2">Introduction to NOSQL and cassandra, part 2</a></h1>
      <p class="postmetadata">January 20th, 2010 | <a href="../../2010/01/20/introduction-to-nosql-and-cassandra-part-2/index.html#comments" title="Comment on Introduction to NOSQL and cassandra, part 2">4 Comments &#187;</a></p>
      
      <div class="entry">
        <div class="tweetmeme_button" style="float: right; margin-left: 10px;"><a class="tm_button" rel="&amp;style=normal&amp;b=2" href="../../2010/01/20/introduction-to-nosql-and-cassandra-part-2/index.html"></a></div>
<p>In <a href="../../2010/01/09/introduction-to-nosql-and-cassandra-part-1/index.html">part 1</a> of this talk I presented few of the theoretical  concepts behind nosql and cassandra.</p>
<p>In this talk we deep dive into the Cassandra API and implementation. The video is again in Hebrew, but the slides are multilingual ;-)<br />
<object width="425" height="344"><param name="movie" value="http://www.youtube.com/v/8P_wAe6Xpxw&amp;hl=en_US&amp;fs=1&amp;"></param><param name="allowFullScreen" value="true"></param><param name="allowscriptaccess" value="always"></param><embed src="http://www.youtube.com/v/8P_wAe6Xpxw&amp;hl=en_US&amp;fs=1&amp;" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="344"></embed></object><br />
<iframe src="http://docs.google.com/present/embed?id=ahbp3bktzpkc_145c5gmf2gz" frameborder="0" width="410" height="342"></iframe></p>
<ul>
<li>Started with a short recap of some of RDBMS and SQL properties, such as <a href="http://databases.about.com/od/specificproducts/a/acid.htm">ADIC</a>, why SQL if very programmer friendly, but is also limited in its support for large scale systems.</li>
<li><a href="http://databases.about.com/od/specificproducts/a/acid.htm"></a>Short recap of the <a href="http://www.julianbrowne.com/article/viewer/brewers-cap-theorem">CAP theorem</a></li>
<li><a href="http://www.julianbrowne.com/article/viewer/brewers-cap-theorem"></a>Short recap of what N/R/W are</li>
<li>Cassandra Data Model: Cassandra is a column oriented DB which follows a similar data model to <a href="http://labs.google.com/papers/bigtable.html">Google&#8217;s BigTable</a></li>
<li>Do you know SQL? So you better start forgetting it, Cassandra is a different game.</li>
<li>Vocabulary:
<ul>
<li>Keyspace &#8211; a logical buffer for application data. For example &#8211; Billing keyspace, or statistics keyspace, appX keyspace etc</li>
<li>ColumnFamily &#8211; similar to SQL tables. Aggregates columns and rows</li>
<li>Keys (or Rows). Each set of columns is identified by a key. A key is unique per Column Family</li>
<li>Columns &#8211; the actual values. Columns are represented by triplets &#8211; (name, value, timestamp)</li>
<li>Super-Columns &#8211; Facebook&#8217;s addition to the BigTable model SuperColumns are columns who&#8217;s values is a list of Columns. (but this is not recursive, you can only have one level of super-columns)</li>
</ul>
</li>
<li><a href="http://labs.google.com/papers/bigtable.html"></a>One way to think of cassandra is as a key-value store, but with extra functionality:
<ul>
<li>Each key has multiple values. In Cassandra jargon those are Columns</li>
<li>When reading or writing data it&#8217;s possible to read/write a set of columns for one specific key (row) atomically. This set of columns may either be a specified by the list column names, or by a slice predicate, assuming the columns are sorted in some way (that&#8217;s a configuration parameter)</li>
<li>In a addition, a multi-get operation is supported and a row-range-read operation is supported as well.</li>
<li>Row-range-read operations are supported only of a partitioner is defined which supports that (configuration parameter)</li>
</ul>
</li>
<li><strong>Key concept</strong>: In SQL you add your data first and then retrieve it in ad-hoc manner using select queries and where clauses; In Cassandra you can&#8217;t do that. Data can only be retrieved by it&#8217;s row key, so you have to think about how you&#8217;re going to be reading your data before you insert it. This is a conceptual diff b/w SQL and Cassandra.</li>
<li>I covered the Cassandra API methods:
<ul>
<li>get</li>
<li>get_slice</li>
<li>multiget</li>
<li>multiget_slice</li>
<li>get_count</li>
<li>get_range_slice</li>
<li>insert</li>
<li>batch_insert</li>
<li>delete</li>
<li>(these are the 0.4 api method. In 0.5 it&#8217;s a little different)</li>
</ul>
</li>
<li>Between N/R/W, N is set per keyspace; R is defined per each read operation (get/multiget/etc) and W is defined per write operation (insert/batch_insert/delete)</li>
<li>Applications play with their R/W values to get different effects, for example they use QUORUM to get high consistency levels, or DC_QUORUM for a balance of high consistency and performance, W=0 to have async writes with reduced consistency.</li>
<li>Cassandra defines different sorting orders on it&#8217;s columns. Sort order may be defined at the ColumnFamily level and is used to get a slice of columns, for example, read all columns that start with a&#8230; and end with z&#8230;</li>
<li>There are several out of the box sort types, such as ascii, utf, numeric and date; Applications may also add their own sorters; This is as far as I recall the only place where Cassandra allows external code to be hooked in.</li>
<li>Thrift is a protocol and a library for cross-process communication and is used by Cassandra. You define a thrift interface and then compile it to the language of your choosing &#8211; C++, Java, Python, PHP etc. This makes it very easy for cross-language processes to talk to each other.</li>
<li>Thrift is also very efficient serializing and  deserializing objects and is also space-efficient (much more than Java serialization is).</li>
<li>I did not have enough time to cover the <a href="http://en.wikipedia.org/wiki/Gossip_protocol">Gossip protocol</a> used by Cassandra internally to learn about the health of its hosts.</li>
<li>I also did not have enough time to cover the Repair-on-reads algorithm used by Cassandra to repair data inconsistencies lazily.</li>
<li>I did not have time to talk about <a href="http://en.wikipedia.org/wiki/Consistent_hashing">consistent hashing</a>, which is what cassandra implements internally to reduce overhead of joined or dropped hosts occurrences.</li>
</ul>
<p>So, as you can see, this was an overloaded, 1h+ talk with a lot to grasp. Wish me luck implementing Cassandra into outbrain!</p>
<script type='text/javascript'>
		<!--
		//OBSTART:do_NOT_remove_this_comment
		var OutbrainPermaLink="../../2010/01/20/introduction-to-nosql-and-cassandra-part-2/index.html";
		if(typeof(OB_Script)!='undefined'){OutbrainStart();} else {
		var OB_PlugInVer="7.0.0.0_Regular";;var OB_raterMode="stars";var OB_recMode="rec";var OBITm="1263219542";var OB_Script=true;var OB_langJS="";document.write(unescape("%3Cscript src='http://widgets.outbrain.com/OutbrainRater.js' type='text/javascript'%3E%3C/script%3E"));}
		//OBEND:do_NOT_remove_this_comment
		//-->
		</script>
		              </div>
      <!-- <p class="postmetadata2">Published in <a href="http://prettyprint.me/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a> -->
      <!-- by <php the_author(); ?> , January 20th, 2010 --> 
      <br />
      	</p></p>
    </div>
      <div class="post" id="post-227">
      <h1><a href="../../2010/01/14/maven-code-quality-dashboard-and-teamcity/index.html" rel="bookmark" title="Permalink to Maven Code Quality Dashboard and TeamCity">Maven Code Quality Dashboard and TeamCity</a></h1>
      <p class="postmetadata">January 14th, 2010 | <a href="../../2010/01/14/maven-code-quality-dashboard-and-teamcity/index.html#comments" title="Comment on Maven Code Quality Dashboard and TeamCity">5 Comments &#187;</a></p>
      
      <div class="entry">
        <div class="tweetmeme_button" style="float: right; margin-left: 10px;"><a class="tm_button" rel="&amp;style=normal&amp;b=2" href="../../2010/01/14/maven-code-quality-dashboard-and-teamcity/index.html"></a></div>
<p>I&#8217;ve recently implemented a code-quality dashboard at <a href="http://outbrain.com/">outbrain</a> for <a href="http://maven.apache.org/">maven</a> java projects and hooked it into the our <a href="http://www.jetbrains.com/teamcity/index.html">TeamCity</a> continuous integration server. I was very pleased with the result, but the process had a few hickups, so I thought I&#8217;d mention them here for future generations.</p>
<p>A code quality dashboard includes the following components:</p>
<ul>
<li>Tests status &#8211; failed, passed and  skipped count <strong>along with good looking graphs</strong></li>
<li><strong>Code coverage</strong> report detailing all covered and uncovered lines and branches, including nice coverage graphs</li>
<li><strong> Copy-Paste detection</strong> by <a href="http://pmd.sourceforge.net/cpd.html">CPD</a></li>
<li><a href="http://findbugs.sourceforge.net/">FindBugs</a> report</li>
<li><a href="http://clarkware.com/software/JDepend.html">jDepend</a> report</li>
</ul>
<p>The process had two phases: phase one is where I add the dashboard report to maven&#8217;s site goal in my pom.xml and phase two is where I make this report available at TeamCity, which is a bit of a manual work bot not too bad.</p>
<p>To add those nice reports, edit your pom.xml to add:</p>

<div class="wp_syntax"><div class="code"><pre class="xml" style="font-family:monospace;">  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;reporting<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;plugins<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.codehaus.mojo<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>cobertura-maven-plugin<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.apache.maven.plugins<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>maven-pmd-plugin<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>2.3<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;linkXref<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>true<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/linkXref<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;targetJdk<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>1.5<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/targetJdk<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.apache.maven.plugins<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>maven-surefire-report-plugin<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>2.4.2<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.codehaus.mojo<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>jdepend-maven-plugin<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.codehaus.mojo<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>findbugs-maven-plugin<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>2.0.1<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;xmlOutput<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>true<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/xmlOutput<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;effort<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>Max<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/effort<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.codehaus.mojo<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>dashboard-maven-plugin<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/plugins<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/reporting<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></div></div>

<p>Now, in theory, that would have been all. All you have to do is run <em><strong>mvn site</strong></em> and bang &#8211; you have the reports under target/site. That&#8217;s why maven is nice.</p>
<p>However, if you&#8217;re running a multi-module project then mvn-site is buggy&#8230; all links to the subproject are broken links. But no despair, here&#8217;s the solution &#8211; configure the site plugin to place its generated content where the site plugin expects it to be&#8230; yeah, I know it sounds confusing, the thing is that the site plugin has a bug so it&#8217;s links to the submodule projects are broken, but here&#8217;s an easy fix that worked for me (as long as the projects are only one directory deep under the parent pom.xml). In the parent pom.xml add:</p>

<div class="wp_syntax"><div class="code"><pre class="xml" style="font-family:monospace;">      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>org.apache.maven.plugins<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>maven-site-plugin<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
          <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;outputDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>../target/site/${project.name}<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/outputDirectory<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/plugin<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></div></div>

<p>Now the reports are fixed.</p>
<p>Next step is to add them into TeamCity.</p>
<p>Step one: Tell teamcity to collect the site artifacts (html, css, js&#8230;). Go to the build configuration and under Artifacts Paths add <strong>**/target/site/**/*</strong></p>
<p><a href="../../wp-content/uploads/2010/01/Trunk-Code-Quality-Configuration-TeamCity.png"><img class="size-full wp-image-234 alignnone" title="Trunk Code Quality Configuration -- TeamCity" src="../../wp-content/uploads/2010/01/Trunk-Code-Quality-Configuration-TeamCity.png" alt="" width="590" height="161" /></a></p>
<p>Step two: Add a Code Quality tab to the build results. You do that by ssh-ing to the teamc host and editing</p>
<pre>vi /teamc/TeamCity/.BuildServer/config/main-config.xml</pre>
<p>to add</p>
<pre>&lt;report-tab title="Code Quality" basePath="target/site/" startPage="dashboard-report-details.html" /&gt;</pre>
<p>Here&#8217;s the result:</p>
<p><img class="alignnone size-full wp-image-233" title="Code Quality Tab" src="../../wp-content/uploads/2010/01/Trunk-__-Trunk-Code-Quality-8-13-Jan-10-20_43-Overview-TeamCity.png" alt="" width="632" height="83" /></p>
<p>That&#8217;s it! Now run your build with mvn site and get those gorgeous looking reports right in your teamcity build results page.<br />
<a href="../../wp-content/uploads/2010/01/Global-DashBoard-Report.png"><img class="size-full wp-image-228 alignnone" title="Global DashBoard Report" src="../../wp-content/uploads/2010/01/Global-DashBoard-Report.png" alt="" width="715" height="677" /></a></p>
<p><img class="size-full wp-image-230 alignnone" title="Outrain Root Project - DashBoard Report" src="../../wp-content/uploads/2010/01/Outrain-Root-Project-DashBoard-Report-2.png" alt="" width="590" height="359" /></p>
<p><a href="../../wp-content/uploads/2010/01/Outrain-Root-Project-DashBoard-Report-1-1.png"><img class="size-full wp-image-229 alignnone" title="Outrain Root Project - DashBoard Report" src="../../wp-content/uploads/2010/01/Outrain-Root-Project-DashBoard-Report-1-1.png" alt="" width="441" height="274" /></a></p>
<p><a href="../../wp-content/uploads/2010/01/Coverage-Report.png"><img class="alignnone size-full wp-image-236" title="Coverage Report" src="../../wp-content/uploads/2010/01/Coverage-Report.png" alt="" width="703" height="536" /></a></p>
<p><a href="../../wp-content/uploads/2010/01/Coverage-Report-1.png"><img class="alignnone size-full wp-image-235" title="Coverage Report" src="../../wp-content/uploads/2010/01/Coverage-Report-1.png" alt="" width="460" height="378" /></a><img class="alignnone size-full wp-image-237" title="FindBugs piechart" src="../../wp-content/uploads/2010/01/ImageFetcher-DashBoard-Report.png" alt="" width="825" height="426" /></p>
<script type='text/javascript'>
		<!--
		//OBSTART:do_NOT_remove_this_comment
		var OutbrainPermaLink="../../2010/01/14/maven-code-quality-dashboard-and-teamcity/index.html";
		if(typeof(OB_Script)!='undefined'){OutbrainStart();} else {
		var OB_PlugInVer="7.0.0.0_Regular";;var OB_raterMode="stars";var OB_recMode="rec";var OBITm="1263219542";var OB_Script=true;var OB_langJS="";document.write(unescape("%3Cscript src='http://widgets.outbrain.com/OutbrainRater.js' type='text/javascript'%3E%3C/script%3E"));}
		//OBEND:do_NOT_remove_this_comment
		//-->
		</script>
		              </div>
      <!-- <p class="postmetadata2">Published in <a href="http://prettyprint.me/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a> -->
      <!-- by <php the_author(); ?> , January 14th, 2010 --> 
      <br />
      	</p></p>
    </div>
      <div class="post" id="post-223">
      <h1><a href="../../2010/01/11/moved-hosting-away-from-godaddy-sucks/index.html" rel="bookmark" title="Permalink to Moved hosting away from #godaddy #sucks">Moved hosting away from #godaddy #sucks</a></h1>
      <p class="postmetadata">January 11th, 2010 | <a href="../../2010/01/11/moved-hosting-away-from-godaddy-sucks/index.html#comments" title="Comment on Moved hosting away from #godaddy #sucks">12 Comments &#187;</a></p>
      
      <div class="entry">
        <div class="tweetmeme_button" style="float: right; margin-left: 10px;"><a class="tm_button" rel="&amp;style=normal&amp;b=2" href="../../2010/01/11/moved-hosting-away-from-godaddy-sucks/index.html"></a></div>
<p><a href="../../wp-content/uploads/2010/01/go_daddy_sucks.png"><img class="alignleft size-full wp-image-224" title="go_daddy_sucks" src="../../wp-content/uploads/2010/01/go_daddy_sucks.png" alt="" width="270" height="103" /></a><br />
This blog has moved away from <a href="http://www.godaddy.com/">GoDaddy</a> hosting to <a href="https://www.bluehost.com/">bluehost</a>. I don&#8217;t know how good bluehost is (so far it&#8217;s been OK) but I know for sure that GoDaddy is pretty darn awful.</p>
<div style="clear: both;"></div>
<div style="clear: both;">Awful as in</div>
<div style="clear: both;">
<ul>
<li>So slow that it&#8217;s a nightmare to be editing posts online. I had to do them offline and then copy-paste (and reformat), what a waste of time.</li>
<li>So fragile that my <a href="http://www.pingdom.com/">pingdom</a> monitor reports it unavailable for more than 5 minutes at least twice a day.</li>
<li>So unresponsive that I&#8217;m sometimes ashamed to share permalinks to my blog in fear it would be offline. Why did I even pay them?</li>
</ul>
<p>I didn&#8217;t wait for the one year I paid up front to end, just packed my stuff and moved over to bluehost. I don&#8217;t know how good bluehost is, but at least it&#8217;s fun again to be editing online and my pingdom monitor hasn&#8217;t told me anything bad yet, so knock on wood, looking good so far.</p>
</div>
<script type='text/javascript'>
		<!--
		//OBSTART:do_NOT_remove_this_comment
		var OutbrainPermaLink="../../2010/01/11/moved-hosting-away-from-godaddy-sucks/index.html";
		if(typeof(OB_Script)!='undefined'){OutbrainStart();} else {
		var OB_PlugInVer="7.0.0.0_Regular";;var OB_raterMode="stars";var OB_recMode="rec";var OBITm="1263219542";var OB_Script=true;var OB_langJS="";document.write(unescape("%3Cscript src='http://widgets.outbrain.com/OutbrainRater.js' type='text/javascript'%3E%3C/script%3E"));}
		//OBEND:do_NOT_remove_this_comment
		//-->
		</script>
		              </div>
      <!-- <p class="postmetadata2">Published in <a href="http://prettyprint.me/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a> -->
      <!-- by <php the_author(); ?> , January 11th, 2010 --> 
      <br />
      	</p></p>
    </div>
      <div class="post" id="post-220">
      <h1><a href="../../2010/01/09/introduction-to-nosql-and-cassandra-part-1/index.html" rel="bookmark" title="Permalink to Introduction to NOSQL and cassandra, part 1">Introduction to NOSQL and cassandra, part 1</a></h1>
      <p class="postmetadata">January 9th, 2010 | <a href="../../2010/01/09/introduction-to-nosql-and-cassandra-part-1/index.html#comments" title="Comment on Introduction to NOSQL and cassandra, part 1">7 Comments &#187;</a></p>
      
      <div class="entry">
        <div class="tweetmeme_button" style="float: right; margin-left: 10px;"><a class="tm_button" rel="&amp;style=normal&amp;b=2" href="../../2010/01/09/introduction-to-nosql-and-cassandra-part-1/index.html"></a></div>
<p>I recently gave a talk at <a href="http://outbrain.com/">outbrain</a>, where I work, about an introduction to no-sql and Cassandra as we&#8217;re looking for alternatives of scaling out our database solution to match our incredible growth rate.</p>
<p><a href="http://en.wikipedia.org/wiki/NoSQL">NOSQL</a> is a general name for many non relational databases and <a href="http://incubator.apache.org/cassandra/">Cassandra</a> is one of them.</p>
<p>This was the first session of two in which I introduced the theoretical background and explained few of the important concepts of nosql. In the second session, due next week, I&#8217;ll talk more specifically about Cassandra.</p>
<p>The talk is on youtube, video below, but it&#8217;s in Hebrew so I&#8217;ll share it&#8217;s outline in English here. Slides are enclosed as well.</p>
<p><object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="425" height="344" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"><param name="src" value="http://www.youtube.com/v/fWkEeyT3e2Y&amp;hl=en_US&amp;fs=1&amp;rel=0" /><param name="allowfullscreen" value="true" /><embed type="application/x-shockwave-flash" width="425" height="344" src="http://www.youtube.com/v/fWkEeyT3e2Y&amp;hl=en_US&amp;fs=1&amp;rel=0" allowfullscreen="true"></embed></object><br />
<iframe src="http://docs.google.com/present/embed?id=ahbp3bktzpkc_145c5gmf2gz" frameborder="0" width="410" height="342"></iframe></p>
<ul>
<li>SQL and relational DBs in general offer is a very good general purpose solution for many  applications such as blogs, banking, my cat&#8217;s site etc.</li>
<li>RDBMS provide <a href="http://databases.about.com/od/specificproducts/a/acid.htm">ACID</a>: Atomicity, Consistency, Isolation and Durability</li>
<li>RDBMS + SQL (the query language) + ACID provide a very nice and clean programming interface, suitable for banks, online merchants and many other applications, but not all applications really actually do require full ACID and one has to realize that ACID and SQL features are not without costs when systems need to scale out. Cost is not only in $$, it&#8217;s also in application performance and features.</li>
<li>The new generation of internet scale applications put very high demands on DB systems when it comes to scale and speed of operation but they don&#8217;t necessariry require all the good that&#8217;s in RDBMS, such as Full Consistency or Atomicity.</li>
<li>So, a new brand of DB systems has grown over the past 5 or so years &#8211; nosql, which either stands for No-SQL or Not-Only-SQL.</li>
<li>Leading actors in the nosql arena are Google with its BigTable, Amazon with Dynamo, Facebook with Cassandra and there&#8217;s more.</li>
<li>I presented intermediate solutions before going no-sql, namely RDBMS <a href="http://en.wikipedia.org/wiki/Shard_(database_architecture)">sharding</a> which is very common and <a href="http://bret.appspot.com/entry/how-friendfeed-uses-mysql">FriendFeed&#8217;s particularly interesting solution</a> of application level indexing for using mysql with a schema-less data model.</li>
<li>CAP Theorem: At large scale systems you may only choose 2 out of the 3 desired attributes: Consistency, Availability and Partition-Tolerance. All three may not go hand in hand and application designers need to realize that.</li>
<li>A Consistent and Available system with no Partition-tolerance is a RDBMS system that comes to a halt if one of it&#8217;s hosts is down. That&#8217;s a very commonly used solution and perfect for small systems. This blog, for example, which uses WordPress, also uses a single mysql server which, if happens to be down, will also take the blog down. However, for internet scale systems where at almost any point in time there&#8217;s a good chance that one of the nodes is either down, or there are network disruptions, the No-Partition-Tolerance approach just isn&#8217;t going to cut it and they will have to choose a different approach for providing their SLAs.</li>
<li>Systems that are Available at all times and are capable of handling Partitions must sacrifice their consistency. As it turns out, though, this isn&#8217;t bad as it seems, as there are pretty good alternatives for lower levels of consistently, one such solution is <a href="http://en.wikipedia.org/wiki/Eventual_consistency">Eventual Consistency</a>, which actually works pretty nicely for &#8220;social applications&#8221; such as Google&#8217;s Facebook&#8217;s and Outbrain&#8217;s</li>
<li>I introduced the concept of NRW &#8211; N is the number of database replicas data is copied to one must replicate data in order to withstand partitions. W is the number of replicas a write operation would block on until it returns to it&#8217;s caller and is &#8220;successful&#8221; and R is the number of replicas a read operation would block on before returning to its caller.</li>
<li>N, R and W are crucial when dealing with Eventual Consistency as their values usually determine the level of consistency you&#8217;re going to have. For example, when N=R=W you have a full consistency (which isn&#8217;t tolerant to partitions or course). When W=0 you have async writes, which is the lowest level of consistency (you never know when the write operation actually finishes)</li>
<li>I introduced the concept of <a href="http://en.wikipedia.org/wiki/Atomicity_(database_systems)">Quorum</a>, which means R=W=ceil((N+1)/2)</li>
<li>Introduced a (very partial) list of currently available nosql solutions, such as Cassandra, BigTable, HBase, Dynamo, Voldemort, Riak, CouchDB, MongoDB and more.</li>
</ul>
<p>Overall this was a very interesting talk, a lot of (fun and interesting) theory. The next part is going to be specific about Cassandra &#8211; how all this theory fits into Cassandra and how does one use Cassandra&#8217;s API, so stay tuned.</p>
<script type='text/javascript'>
		<!--
		//OBSTART:do_NOT_remove_this_comment
		var OutbrainPermaLink="../../2010/01/09/introduction-to-nosql-and-cassandra-part-1/index.html";
		if(typeof(OB_Script)!='undefined'){OutbrainStart();} else {
		var OB_PlugInVer="7.0.0.0_Regular";;var OB_raterMode="stars";var OB_recMode="rec";var OBITm="1263219542";var OB_Script=true;var OB_langJS="";document.write(unescape("%3Cscript src='http://widgets.outbrain.com/OutbrainRater.js' type='text/javascript'%3E%3C/script%3E"));}
		//OBEND:do_NOT_remove_this_comment
		//-->
		</script>
		              </div>
      <!-- <p class="postmetadata2">Published in <a href="http://prettyprint.me/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a> -->
      <!-- by <php the_author(); ?> , January 9th, 2010 --> 
      <br />
      	</p></p>
    </div>
      <div class="post" id="post-206">
      <h1><a href="../../2009/11/13/stringtemplate-a-step-forward-to-a-better-web-mvc/index.html" rel="bookmark" title="Permalink to StringTemplate &#8211; a step forward to a better web MVC">StringTemplate &#8211; a step forward to a better web MVC</a></h1>
      <p class="postmetadata">November 13th, 2009 | <a href="../../2009/11/13/stringtemplate-a-step-forward-to-a-better-web-mvc/index.html#comments" title="Comment on StringTemplate &#8211; a step forward to a better web MVC">4 Comments &#187;</a></p>
      
      <div class="entry">
        <div class="tweetmeme_button" style="float: right; margin-left: 10px;"><a class="tm_button" rel="&amp;style=normal&amp;b=2" href="../../2009/11/13/stringtemplate-a-step-forward-to-a-better-web-mvc/index.html"></a></div>
<p><img class="alignleft size-thumbnail wp-image-208" title="MVC" src="../../wp-content/uploads/2009/11/MVC8x6_209DEC49-150x150.png" alt="MVC" width="150" height="150" /><a href="http://en.wikipedia.org/wiki/Model–view–controller">MVC</a>, Model View Controller is a well known design patten from the field of UI frameworks. It advocates the separation of a Model, an application specific data and business logic, Controller, which takes user input, consults the model and determines the correct view to present a user based on its result and a View, the actual UI component the user interacts with.</p>
<p>In the context of web applications it&#8217;s common to consider a Database along with the application business logic as the Model, a web framework, such as <a href="http://struts.apache.org/">Struts</a>, as the Controller and the rendering engine, such as <a href="http://java.sun.com/products/jsp/">JSP</a> as the View. MVC are widely used in both web development as well as in desktop application development.</p>
<p><a href="http://www.stringtemplate.org/">StringTemplate</a> is a rendering engine, a View, I&#8217;ve recently became familiar with and immediately fell in love with. StringTemplate is a step forward true MVC implementation, but before presenting the solution, let&#8217;s see what the problem is.</p>
<p>The MVC design pattern states that in a UI framework there should be 3 components &#8211; the Model, the View and the Controller. It also states that the Controller should have direct access to the Model and the View, the View have direct access to the Model when presenting the data as seen in the diagram below.</p>
<p><img class="alignnone size-full wp-image-209" title="MVC diagram" src="../../wp-content/uploads/2009/11/350px-ModelViewControllerDiagram.svg.png" alt="MVC diagram" width="350" height="165" /></p>
<p>There are many MVC implementations in many languages. In Java only, there are more than 17 mentioned on the <a href="http://en.wikipedia.org/wiki/Model–view–controller#Java">Wiki page</a>. Many of the frameworks use JSP as their rendering engine and add their specific features to it, so for example <a href="http://struts.apache.org/2.x/">struts2</a> implements a very nice controller and as a rendering engine uses JSP with either struts2 tags or another tag library. The problem lies within JSP.</p>
<p>JSP, similar to PHP, ASP and many other simple and fast-start rendering engines, compromise the MVC model; they allows too much in their View component.</p>
<p>JSP allows code to be executed within the context of the page (using the &lt;% %&gt; notation), which is very nice when you want to hack something fast but is extremely dangerous from code maintenance perspective and is a clear violation of the MVC agreement. If code can be executed within a page, that code can easily alter the model or take actions a controller should have taken. A View should be able to READ the model, but not ALTER it. Even the most disciplined programmers who adhere to clean JSP code by not allowing actual Java code inside their pages (using the &lt;% %&gt;) actually suffer from the same problem without even knowing it&#8230; The alternative to the &lt;%  and the &lt;%= constructs are tags, such as JSTL tags, struts2 tags etc. These tags commonly access the model by invoking its getters, but the real problem with them is that the order in which they execute is very important &#8211; read it again &#8211; the order in which they are displayed on the page is crucial to the correctness of the values returned by their backing model. More about this <a href="http://www.artima.com/lejava/articles/stringtemplate.html">here</a>. So with JSP, when using tags, the View implementor has to understand how a Model works in order to succeed. That&#8217;s both inconsistent with the pure MVC model and inconvenient to the UI designer. Lastly are side effect, which cannot be ignored. Views can create side effects by calling methods (even getters can have side effects!) , which I think there&#8217;s no need to mention, is very bad.</p>
<p>StringTemplate comes to the rescue. As a matter of fact, when I programmed django MVC in python, as well as Cheetah in python, I have to say that both MVCs were much stricter than JSP and were therefore a lot more programmer-friendly. But in Java we had Velocity, which is strict, but also less powerful and now we have StringTemplate which is both strict and powerful. (and no &#8211; freemarker isn&#8217;t any better than just plain JSP, sorry).</p>
<p>At outbrain we use struts2 as our MVC driver and so to be able to use StringTemplate as the View engine I&#8217;ve implemented a struts2 View Renderer. Full code and details below. This code is &#8220;unstable&#8221; which means it&#8217;s been developed and tested, so far no bugs or missing features, but hasn&#8217;t gone to production yet.</p>
<p><strong>struts.xml:</strong></p>

<div class="wp_syntax"><div class="code"><pre class="xml" style="font-family:monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;struts<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;include</span> <span style="color: #000066;">file</span>=<span style="color: #ff0000;">&quot;webwork-default.xml&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;package</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;regular&quot;</span> <span style="color: #000066;">namespace</span>=<span style="color: #ff0000;">&quot;/&quot;</span> <span style="color: #000066;">extends</span>=<span style="color: #ff0000;">&quot;struts-default&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;result-types<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;result-type</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;stringtemplate&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;org.apache.struts2.dispatcher.StringTemplateResult&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/result-types<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;action</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;st&quot;</span> <span style="color: #000066;">class</span>=<span style="color: #ff0000;">&quot;com.mysite.StringTemplateTestAction&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;result</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;success&quot;</span> <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;stringtemplate&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>/WEB-INF/st/page.st<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/result<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/action<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/package<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/struts<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></div></div>

<div><strong>Java source code:</strong></div>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">package</span> <span style="color: #006699;">org.apache.struts2.dispatcher</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.io.IOException</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.io.InputStream</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.io.Writer</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.util.Enumeration</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.util.HashMap</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.util.Locale</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.util.Map</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.util.Properties</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">javax.servlet.ServletContext</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">javax.servlet.http.HttpServletRequest</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">javax.servlet.http.HttpServletResponse</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">javax.servlet.http.HttpSession</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.antlr.stringtemplate.NoIndentWriter</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.antlr.stringtemplate.StringTemplate</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.antlr.stringtemplate.StringTemplateGroup</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.antlr.stringtemplate.StringTemplateWriter</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.commons.logging.Log</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.commons.logging.LogFactory</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.struts2.ServletActionContext</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.struts2.StrutsConstants</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.struts2.views.util.ContextUtil</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">org.apache.struts2.views.util.ResourceUtil</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">com.opensymphony.xwork2.ActionInvocation</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">com.opensymphony.xwork2.LocaleProvider</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">com.opensymphony.xwork2.inject.Inject</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">com.opensymphony.xwork2.util.ValueStack</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">freemarker.template.Configuration</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">freemarker.template.TemplateException</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #008000; font-style: italic; font-weight: bold;">/**
 * Defines the StringTemplate result type for struts2.
 *
 * To use this result type add the following configuration to your struts.xml:
 *
 * &lt;code&gt;
 * &amp;lt;result-types&amp;gt;
 *   &amp;lt;result-type name=&quot;stringtemplate&quot;
 *       class=&quot;org.apache.struts2.dispatcher.StringTemplateResult&quot;/&amp;gt;
 * &amp;lt;/result-types&amp;gt;
 *&lt;/code&gt;
 *
 * Template files should be located relative to /WEB-INF/st/, so for example a common layout
 * would be:
 *
&lt;ul&gt;
 *
	&lt;li&gt;/WEB-INF/st/pages/page1.st&lt;/li&gt;
*
	&lt;li&gt;/WEB-INF/st/layouts/layout1.st&lt;/li&gt;
*
	&lt;li&gt;/WEB-INF/st/snippets/header.st&lt;/li&gt;
*
	&lt;li&gt;/WEB-INF/st/snippets/footer.st&lt;/li&gt;
*&lt;/ul&gt;
*
 * So page1.st would look like:
 * &lt;code&gt;
 * $layouts/layout1(header=snippets/header(), footer=snippets/footer())$
 * &lt;/code&gt;
 *
 * And the associated struts action would be:
 *
 * &lt;code&gt;
 * &amp;lt;action name=&quot;page1&quot;
 *      class=&quot;com.mycompany.Page1Action&quot;&amp;gt;
 *        &amp;lt;result name=&quot;success&quot;
 *          type=&quot;stringtemplate&quot;&amp;gt;/WEB-INF/st/pages/page1.st&amp;lt;/result&amp;gt;
 * &amp;lt;/action&amp;gt;
 * &lt;/code&gt;
 *
 * Localization:
 * All string property files should be packed into the classpath (in one of the jars) at
 * /lang/.
 * For example:
 *
&lt;ul&gt;
 *
	&lt;li&gt;/lang/en_US.properties&lt;/li&gt;
*
	&lt;li&gt;/lang/fr_FR.properties&lt;/li&gt;
*&lt;/ul&gt;
*
 * @author Ran Tavory (ran@outbrain.com)
 *
 */</span>
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> StringTemplateResult <span style="color: #000000; font-weight: bold;">extends</span> StrutsResultSupport <span style="color: #009900;">&#123;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * Base path of StringTemplate template files.
   * This is usually something like /WEB-INF/ or /WEB-INF/st/.
   * Must end with /.
   * All templates should reside in subdirectories of this base path and when referencing
   * each other the reference point should be relative to this path.
   * For example, if you have /WEB-INF/pages/page1.st and /WEB-INF/layouts/layout1.st, and assuming
   * the base path is at /WEB-INF then page1 is pages/page1 and layout1 is layouts/layout1.
   * To reference layout1 from page1: $layouts/layout1()$
   */</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">String</span> TEMPLATES_BASE <span style="color: #339933;">=</span>
      <span style="color: #0000ff;">&quot;/WEB-INF/st/&quot;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * Path to the language resource files within the classpath.
   *
   * Resource should be packed inside a jar under /lang/.
   * For example: /lang/en_US.properties
   */</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">String</span> LANG_RESOURCE_BASE <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;/lang/&quot;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * If there was an exception during execution it's accessible via $exception$
   */</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">String</span> KEY_EXCEPTION <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;exception&quot;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * Session values are accessible via $session.key$
   */</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">String</span> KEY_SESSION <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;session&quot;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * All localized strings are accessible via $strings.string_key$
   */</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">String</span> KEY_STRINGS <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;strings&quot;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * Request parameters are accessible via $params.key$
   */</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">String</span> KEY_REQUEST_PARAMETERS <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;params&quot;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * Request attributes are accessible via $request.attribute$
   */</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">String</span> KEY_REQUEST <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;request&quot;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000000; font-weight: bold;">final</span> Log log <span style="color: #339933;">=</span> LogFactory.<span style="color: #006633;">getLog</span><span style="color: #009900;">&#40;</span>StringTemplateResult.<span style="color: #000000; font-weight: bold;">class</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #000066; font-weight: bold;">long</span> serialVersionUID <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>2390940981629097944L<span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">Locale</span> DEFAULT_LOCALE <span style="color: #339933;">=</span> <span style="color: #003399;">Locale</span>.<span style="color: #006633;">US</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #666666; font-style: italic;">/*
   * Struts results are constructed for each result execution
   *
   * the current context is available to subclasses via these protected fields
   */</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">String</span> contentType <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;text/html&quot;</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">String</span> defaultEncoding<span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">public</span> StringTemplateResult<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #000000; font-weight: bold;">super</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">public</span> StringTemplateResult<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> location<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #000000; font-weight: bold;">super</span><span style="color: #009900;">&#40;</span>location<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setContentType<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> aContentType<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    contentType <span style="color: #339933;">=</span> aContentType<span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * allow parameterization of the contentType the default being text/html
   */</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">String</span> getContentType<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #000000; font-weight: bold;">return</span> contentType<span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  @Inject<span style="color: #009900;">&#40;</span>StrutsConstants.<span style="color: #006633;">STRUTS_I18N_ENCODING</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> setDefaultEncoding<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> val<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    defaultEncoding <span style="color: #339933;">=</span> val<span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * Execute this result, using the specified template location.
   *
&nbsp;
   * The template location has already been interpolated for any variable
   * substitutions.
   *
   * NOTE: The current implementation is still under development and has several restrictions.
   *
&lt;ul&gt;
   *
	&lt;li&gt;All template files must end with .st&lt;/li&gt;
*&lt;/ul&gt;
*/</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> doExecute<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> location, ActionInvocation invocation<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">IOException</span>,
      TemplateException <span style="color: #009900;">&#123;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">final</span> HttpServletRequest request <span style="color: #339933;">=</span> ServletActionContext.<span style="color: #006633;">getRequest</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">final</span> HttpServletResponse response <span style="color: #339933;">=</span> ServletActionContext.<span style="color: #006633;">getResponse</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span>location.<span style="color: #006633;">startsWith</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;/&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #666666; font-style: italic;">// Create a fully qualified resource name.</span>
      <span style="color: #666666; font-style: italic;">// final ActionContext ctx = invocation.getInvocationContext();</span>
      <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">String</span> base <span style="color: #339933;">=</span> ResourceUtil.<span style="color: #006633;">getResourceBase</span><span style="color: #009900;">&#40;</span>request<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      location <span style="color: #339933;">=</span> base <span style="color: #339933;">+</span> <span style="color: #0000ff;">&quot;/&quot;</span> <span style="color: #339933;">+</span> location<span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">String</span> encoding <span style="color: #339933;">=</span> getEncoding<span style="color: #009900;">&#40;</span>location<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #003399;">String</span> contentType <span style="color: #339933;">=</span> getContentType<span style="color: #009900;">&#40;</span>location<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>encoding <span style="color: #339933;">!=</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      contentType <span style="color: #339933;">=</span> contentType <span style="color: #339933;">+</span> <span style="color: #0000ff;">&quot;;charset=&quot;</span> <span style="color: #339933;">+</span> encoding<span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    response.<span style="color: #006633;">setContentType</span><span style="color: #009900;">&#40;</span>contentType<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">String</span> basePath <span style="color: #339933;">=</span> ServletActionContext.<span style="color: #006633;">getServletContext</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">getRealPath</span><span style="color: #009900;">&#40;</span>TEMPLATES_BASE<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">final</span> StringTemplateGroup group <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> StringTemplateGroup<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;webpages&quot;</span>, basePath<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #003399;">String</span> fileName <span style="color: #339933;">=</span> location<span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>fileName.<span style="color: #006633;">endsWith</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;.st&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #666666; font-style: italic;">// If filename ends with .st, remove it.</span>
      fileName <span style="color: #339933;">=</span> fileName.<span style="color: #006633;">substring</span><span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">0</span>, fileName.<span style="color: #006633;">length</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #339933;">-</span> <span style="color: #0000ff;">&quot;.st&quot;</span>.<span style="color: #006633;">length</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>fileName.<span style="color: #006633;">startsWith</span><span style="color: #009900;">&#40;</span>TEMPLATES_BASE<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #666666; font-style: italic;">// If filename includes the base dir then remove it.</span>
      fileName <span style="color: #339933;">=</span> fileName.<span style="color: #006633;">substring</span><span style="color: #009900;">&#40;</span>TEMPLATES_BASE.<span style="color: #006633;">length</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #000000; font-weight: bold;">final</span> StringTemplate template <span style="color: #339933;">=</span> group.<span style="color: #006633;">getInstanceOf</span><span style="color: #009900;">&#40;</span>fileName<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">Map</span> model <span style="color: #339933;">=</span> createModel<span style="color: #009900;">&#40;</span>invocation<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    template.<span style="color: #006633;">setAttributes</span><span style="color: #009900;">&#40;</span>model<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// Output to client</span>
    <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">Writer</span> responseWriter <span style="color: #339933;">=</span> response.<span style="color: #006633;">getWriter</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">final</span> StringTemplateWriter templateWriter <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> NoIndentWriter<span style="color: #009900;">&#40;</span>responseWriter<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    template.<span style="color: #006633;">write</span><span style="color: #009900;">&#40;</span>templateWriter<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #666666; font-style: italic;">// Flush'n'close</span>
    responseWriter.<span style="color: #006633;">flush</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    responseWriter.<span style="color: #006633;">close</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * Retrieve the encoding for this template.
   *
   * People can override this method if they want to provide specific encodings
   * for specific templates.
   *
   * @return The encoding associated with this template (defaults to the value
   *         of 'struts.i18n.encoding' property)
   */</span>
  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #003399;">String</span> getEncoding<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> templateLocation<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
    <span style="color: #003399;">String</span> encoding <span style="color: #339933;">=</span> defaultEncoding<span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>encoding <span style="color: #339933;">==</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      encoding <span style="color: #339933;">=</span> <span style="color: #003399;">System</span>.<span style="color: #006633;">getProperty</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;file.encoding&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>encoding <span style="color: #339933;">==</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      encoding <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;UTF-8&quot;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #000000; font-weight: bold;">return</span> encoding<span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * Retrieve the content type for this template.
   *
   * People can override this method if they want to provide specific content
   * types for specific templates (eg text/xml).
   *
   * @return The content type associated with this template (default
   *         &quot;text/html&quot;)
   */</span>
  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #003399;">String</span> getContentType<span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span> templateLocation<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #0000ff;">&quot;text/html&quot;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * Build the instance of the ScopesHashModel, including JspTagLib support
   *
   * Objects added to the model are
   *
   *
&lt;ul&gt;
   *
	&lt;li&gt;Application - servlet context attributes hash model&lt;/li&gt;
*
	&lt;li&gt;JspTaglibs - jsp tag lib factory model&lt;/li&gt;
*
	&lt;li&gt;Request - request attributes hash model&lt;/li&gt;
*
	&lt;li&gt;Session - session attributes hash model&lt;/li&gt;
*
	&lt;li&gt;request - the HttpServletRequst object for direct access&lt;/li&gt;
*
	&lt;li&gt;response - the HttpServletResponse object for direct access&lt;/li&gt;
*
	&lt;li&gt;stack - the OgnLValueStack instance for direct access&lt;/li&gt;
*
	&lt;li&gt;ognl - the instance of the OgnlTool&lt;/li&gt;
*
	&lt;li&gt;action - the action itself&lt;/li&gt;
*
	&lt;li&gt;exception - optional : the JSP or Servlet exception as per the servlet
   * spec (for JSP Exception pages)
   *&lt;/li&gt;
*
	&lt;li&gt;struts - instance of the StrutsUtil class
   *&lt;/li&gt;
*&lt;/ul&gt;
*/</span>
  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #003399;">Map</span> createModel<span style="color: #009900;">&#40;</span>ActionInvocation invocation<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
    ServletContext servletContext <span style="color: #339933;">=</span> ServletActionContext.<span style="color: #006633;">getServletContext</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    HttpServletRequest request <span style="color: #339933;">=</span> ServletActionContext.<span style="color: #006633;">getRequest</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    HttpServletResponse response <span style="color: #339933;">=</span> ServletActionContext.<span style="color: #006633;">getResponse</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    ValueStack stack <span style="color: #339933;">=</span> ServletActionContext.<span style="color: #006633;">getContext</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">getValueStack</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #003399;">Object</span> action <span style="color: #339933;">=</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>invocation <span style="color: #339933;">!=</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      action <span style="color: #339933;">=</span> invocation.<span style="color: #006633;">getAction</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #000000; font-weight: bold;">return</span> buildTemplateModel<span style="color: #009900;">&#40;</span>stack, action, servletContext, request, response, invocation<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Map</span> buildTemplateModel<span style="color: #009900;">&#40;</span>ValueStack stack, <span style="color: #003399;">Object</span> action,
                                                 ServletContext servletContext,
                                                 HttpServletRequest request,
                                                 HttpServletResponse response,
                                                 ActionInvocation invocation<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
    <span style="color: #003399;">Map</span> model <span style="color: #339933;">=</span> buildScopesHashModel<span style="color: #009900;">&#40;</span>servletContext, request, response, stack<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    populateContext<span style="color: #009900;">&#40;</span>model, stack, action, request, response<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    populateStrings<span style="color: #009900;">&#40;</span>model, deduceLocale<span style="color: #009900;">&#40;</span>invocation<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">return</span> model<span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * Populates the &lt;code&gt;strings&lt;/code&gt; attribute of the model according to the current locale
   * value.
   * @param model
   * @param local
   */</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000066; font-weight: bold;">void</span> populateStrings<span style="color: #009900;">&#40;</span><span style="color: #003399;">Map</span> model, <span style="color: #003399;">Locale</span> locale<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    log.<span style="color: #006633;">debug</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Local: &quot;</span> <span style="color: #339933;">+</span> locale<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #003399;">Properties</span> p<span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">try</span> <span style="color: #009900;">&#123;</span>
      p <span style="color: #339933;">=</span> getLanguageProperties<span style="color: #009900;">&#40;</span>locale<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      model.<span style="color: #006633;">put</span><span style="color: #009900;">&#40;</span>KEY_STRINGS, p<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #000000; font-weight: bold;">return</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">catch</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">IOException</span> e<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>locale.<span style="color: #006633;">equals</span><span style="color: #009900;">&#40;</span>DEFAULT_LOCALE<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        log.<span style="color: #006633;">error</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Unable to load language file for the default locale &quot;</span> <span style="color: #339933;">+</span> locale<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #000000; font-weight: bold;">return</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #009900;">&#123;</span>
        log.<span style="color: #006633;">warn</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;Unable to load language file for &quot;</span> <span style="color: #339933;">+</span> locale <span style="color: #339933;">+</span> <span style="color: #0000ff;">&quot;. Will try to load for the &quot;</span> <span style="color: #339933;">+</span>
            <span style="color: #0000ff;">&quot;default locale&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      <span style="color: #009900;">&#125;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// Try once again with the default locale.</span>
    populateStrings<span style="color: #009900;">&#40;</span>model, DEFAULT_LOCALE<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * Tries to load language properties for the given locale.
   *
   * The file is loaded from /LANG_RESOURCE_BASE/locale.properties in the classpath, so for example
   * that may be /lang/en_US.properties
   *
   * @param locale
   * @return
   * @throws IOException When the language file isn't found or can't read it.
   */</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Properties</span> getLanguageProperties<span style="color: #009900;">&#40;</span><span style="color: #003399;">Locale</span> locale<span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">throws</span> <span style="color: #003399;">IOException</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">InputStream</span> in <span style="color: #339933;">=</span>
      getClass<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">getClassLoader</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">getResourceAsStream</span><span style="color: #009900;">&#40;</span>LANG_RESOURCE_BASE <span style="color: #339933;">+</span> locale <span style="color: #339933;">+</span> <span style="color: #0000ff;">&quot;.properties&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">final</span> <span style="color: #003399;">Properties</span> prop <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">Properties</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    prop.<span style="color: #006633;">load</span><span style="color: #009900;">&#40;</span>in<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">return</span> prop<span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #003399;">Map</span> buildScopesHashModel<span style="color: #009900;">&#40;</span>ServletContext servletContext,
                                                     HttpServletRequest request,
                                                     HttpServletResponse response,
                                                     ValueStack stack<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
    <span style="color: #003399;">Map</span> model <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">HashMap</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// Add session information</span>
    HttpSession session <span style="color: #339933;">=</span> request.<span style="color: #006633;">getSession</span><span style="color: #009900;">&#40;</span><span style="color: #000066; font-weight: bold;">false</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>session <span style="color: #339933;">!=</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      model.<span style="color: #006633;">put</span><span style="color: #009900;">&#40;</span>KEY_SESSION, generateAttributeMapForSession<span style="color: #009900;">&#40;</span>session<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// Add requests attributes</span>
    model.<span style="color: #006633;">put</span><span style="color: #009900;">&#40;</span>KEY_REQUEST, generateAttributeMapFromRequest<span style="color: #009900;">&#40;</span>request<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// Add request parameters.</span>
    model.<span style="color: #006633;">put</span><span style="color: #009900;">&#40;</span>KEY_REQUEST_PARAMETERS, request.<span style="color: #006633;">getParameterMap</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">return</span> model<span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  @SuppressWarnings<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;unchecked&quot;</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Map</span> generateAttributeMapForSession<span style="color: #009900;">&#40;</span>HttpSession session<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
    <span style="color: #003399;">Map</span> attributes <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">HashMap</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">Enumeration</span> e <span style="color: #339933;">=</span> session.<span style="color: #006633;">getAttributeNames</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> e.<span style="color: #006633;">hasMoreElements</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #003399;">String</span> name <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span><span style="color: #009900;">&#41;</span> e.<span style="color: #006633;">nextElement</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      attributes.<span style="color: #006633;">put</span><span style="color: #009900;">&#40;</span>name, session.<span style="color: #006633;">getAttribute</span><span style="color: #009900;">&#40;</span>name<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #000000; font-weight: bold;">return</span> attributes<span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  @SuppressWarnings<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;unchecked&quot;</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #003399;">Map</span> generateAttributeMapFromRequest<span style="color: #009900;">&#40;</span>HttpServletRequest request<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
    <span style="color: #003399;">Map</span> attributes <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #003399;">HashMap</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">for</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">Enumeration</span> e <span style="color: #339933;">=</span> request.<span style="color: #006633;">getAttributeNames</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> e.<span style="color: #006633;">hasMoreElements</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #003399;">String</span> name <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">String</span><span style="color: #009900;">&#41;</span> e.<span style="color: #006633;">nextElement</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
      attributes.<span style="color: #006633;">put</span><span style="color: #009900;">&#40;</span>name, request.<span style="color: #006633;">getAttribute</span><span style="color: #009900;">&#40;</span>name<span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #000000; font-weight: bold;">return</span> attributes<span style="color: #339933;">;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  @SuppressWarnings<span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;unchecked&quot;</span><span style="color: #009900;">&#41;</span>
  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #000066; font-weight: bold;">void</span> populateContext<span style="color: #009900;">&#40;</span><span style="color: #003399;">Map</span> model, ValueStack stack, <span style="color: #003399;">Object</span> action,
                                 HttpServletRequest request, HttpServletResponse response<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// put the same objects into the context that the velocity result uses</span>
    <span style="color: #003399;">Map</span> standard <span style="color: #339933;">=</span> ContextUtil.<span style="color: #006633;">getStandardContext</span><span style="color: #009900;">&#40;</span>stack, request, response<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    model.<span style="color: #006633;">putAll</span><span style="color: #009900;">&#40;</span>standard<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// Support for JSP exception pages, exposing the servlet or JSP exception</span>
    <span style="color: #003399;">Throwable</span> exception <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">Throwable</span><span style="color: #009900;">&#41;</span> request.<span style="color: #006633;">getAttribute</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;javax.servlet.error.exception&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>exception <span style="color: #339933;">==</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      exception <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span><span style="color: #003399;">Throwable</span><span style="color: #009900;">&#41;</span> request.<span style="color: #006633;">getAttribute</span><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;javax.servlet.error.JspException&quot;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>exception <span style="color: #339933;">!=</span> <span style="color: #000066; font-weight: bold;">null</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      model.<span style="color: #006633;">put</span><span style="color: #009900;">&#40;</span>KEY_EXCEPTION, exception<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;">// Add action model.</span>
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>action <span style="color: #000000; font-weight: bold;">instanceof</span> StringTemplateAction<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      StringTemplateAction stAction <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span>StringTemplateAction<span style="color: #009900;">&#41;</span> action<span style="color: #339933;">;</span>
      model.<span style="color: #006633;">putAll</span><span style="color: #009900;">&#40;</span>stAction.<span style="color: #006633;">getModel</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
  <span style="color: #009900;">&#125;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * Returns the locale used for the
   * {@link Configuration#getTemplate(String, Locale)} call. The base
   * implementation simply returns the locale setting of the action (assuming
   * the action implements {@link LocaleProvider}) or, if the action does not
   * the {@link #DEFAULT_LOCALE}
   */</span>
  <span style="color: #000000; font-weight: bold;">protected</span> <span style="color: #003399;">Locale</span> deduceLocale<span style="color: #009900;">&#40;</span>ActionInvocation invocation<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
&nbsp;
    <span style="color: #000000; font-weight: bold;">if</span> <span style="color: #009900;">&#40;</span>invocation.<span style="color: #006633;">getAction</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #000000; font-weight: bold;">instanceof</span> LocaleProvider<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #000000; font-weight: bold;">return</span> <span style="color: #009900;">&#40;</span><span style="color: #009900;">&#40;</span>LocaleProvider<span style="color: #009900;">&#41;</span> invocation.<span style="color: #006633;">getAction</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span>.<span style="color: #006633;">getLocale</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span> <span style="color: #000000; font-weight: bold;">else</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #000000; font-weight: bold;">return</span> DEFAULT_LOCALE<span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
  <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">package</span> <span style="color: #006699;">org.apache.struts2.dispatcher</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">import</span> <span style="color: #006699;">java.util.Map</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #008000; font-style: italic; font-weight: bold;">/**
 * Interface defining the required behavior from a StringTemplate result type.
 *
 * The result should prepare the model for the page to display.
 * The model is a map of attributes -&amp;gt; Objects where each object may either be a simple string, int,
 * etc or another map.
 * So. for example $username$ is accessible from the template of the model contains a String under
 * the value &quot;username&quot; and $strings.hello$ is accessible if the model contains a map under the key
 * &quot;strings&quot; and this map contains an attribute under the key &quot;hello&quot;
 *
 * @author Ran Tavory (ran@outbrain.com)
 *
 */</span>
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">interface</span> StringTemplateAction <span style="color: #009900;">&#123;</span>
&nbsp;
  <span style="color: #008000; font-style: italic; font-weight: bold;">/**
   * Get the root of the display model.
   *
   * The display model is a map of attributes interpolated by StringTemplate at runtime by
   * substituting the $values$ in the template source.
   * For example to replace $user$ with Ran add
   * &lt;code&gt;map.put(&quot;user&quot;, &quot;Ran&quot;);&lt;/code&gt;
   * @return A map of attributes used by StringTemplate to replace in the template.
   */</span>
  <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">Map</span> getModel<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<script type='text/javascript'>
		<!--
		//OBSTART:do_NOT_remove_this_comment
		var OutbrainPermaLink="../../2009/11/13/stringtemplate-a-step-forward-to-a-better-web-mvc/index.html";
		if(typeof(OB_Script)!='undefined'){OutbrainStart();} else {
		var OB_PlugInVer="7.0.0.0_Regular";;var OB_raterMode="stars";var OB_recMode="rec";var OBITm="1263219542";var OB_Script=true;var OB_langJS="";document.write(unescape("%3Cscript src='http://widgets.outbrain.com/OutbrainRater.js' type='text/javascript'%3E%3C/script%3E"));}
		//OBEND:do_NOT_remove_this_comment
		//-->
		</script>
		              </div>
      <!-- <p class="postmetadata2">Published in <a href="http://prettyprint.me/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a> -->
      <!-- by <php the_author(); ?> , November 13th, 2009 --> 
      <br />
      	</p></p>
    </div>
      <div class="post" id="post-182">
      <h1><a href="../../2009/10/02/the-joy-of-deleting-code/index.html" rel="bookmark" title="Permalink to The joy of deleting code">The joy of deleting code</a></h1>
      <p class="postmetadata">October 2nd, 2009 | <a href="../../2009/10/02/the-joy-of-deleting-code/index.html#comments" title="Comment on The joy of deleting code">5 Comments &#187;</a></p>
      
      <div class="entry">
        <div class="tweetmeme_button" style="float: right; margin-left: 10px;"><a class="tm_button" rel="&amp;style=normal&amp;b=2" href="../../2009/10/02/the-joy-of-deleting-code/index.html"></a></div>
<p>What could be more fun than writing a new shiny super-functional, super-tested piece of code? <strong>Deleting it!</strong><br />
When deleting code you know that</p>
<ul>
<li>You have not introduced new bugs. Perhaps you deleted some potential bugs from the old code but chances are you did not introduce new ones.</li>
<li>You don&#8217;t have to maintain it. It&#8217;s deleted.</li>
<li>Code was probably poorly written. Good code is never deleted. In many cases there&#8217;s poorly written code that you just don&#8217;t have the guts to delete it. Now you did, that&#8217;s great.</li>
<li>You&#8217;ve probably found a good way to reuse another piece of code, that&#8217;s why you&#8217;re deleting this piece of code. Code reuse is good.</li>
<li>Or that you&#8217;ve taken off a feature from your product. Taking off features is good, is very good. <a href="http://www.quotationspage.com/quote/26979.html">Perfection is achieved, not when there is nothing more to add, but when there is nothing left to take away</a></li>
<li>Or that you&#8217;ve found a more compact and elegant way to do what you want to do.</li>
</ul>
<p>Bottom line: Deleting code makes me happy. How about you?</p>
<p><img class="alignnone size-full wp-image-202" title="Delete" src="../../wp-content/uploads/2009/10/img_4207.jpg-1600%c3%971200-pixels.png" alt="Delete" width="459" height="323" /></p>
<script type='text/javascript'>
		<!--
		//OBSTART:do_NOT_remove_this_comment
		var OutbrainPermaLink="../../2009/10/02/the-joy-of-deleting-code/index.html";
		if(typeof(OB_Script)!='undefined'){OutbrainStart();} else {
		var OB_PlugInVer="7.0.0.0_Regular";;var OB_raterMode="stars";var OB_recMode="rec";var OBITm="1263219542";var OB_Script=true;var OB_langJS="";document.write(unescape("%3Cscript src='http://widgets.outbrain.com/OutbrainRater.js' type='text/javascript'%3E%3C/script%3E"));}
		//OBEND:do_NOT_remove_this_comment
		//-->
		</script>
		              </div>
      <!-- <p class="postmetadata2">Published in <a href="http://prettyprint.me/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a> -->
      <!-- by <php the_author(); ?> , October 2nd, 2009 --> 
      <br />
      	</p></p>
    </div>
      <div class="post" id="post-168">
      <h1><a href="../../2009/09/20/mavenizing-our-code-base/index.html" rel="bookmark" title="Permalink to Mavenizing our code base">Mavenizing our code base</a></h1>
      <p class="postmetadata">September 20th, 2009 | <a href="../../2009/09/20/mavenizing-our-code-base/index.html#comments" title="Comment on Mavenizing our code base">1 Comment &#187;</a></p>
      
      <div class="entry">
        <div class="tweetmeme_button" style="float: right; margin-left: 10px;"><a class="tm_button" rel="&amp;style=normal&amp;b=2" href="../../2009/09/20/mavenizing-our-code-base/index.html"></a></div>
<p><a title="Maven" href="http://maven.apache.org/">Maven</a> is a build tool for Java. It&#8217;s more than that actually, but let&#8217;s just call it a build tool.</p>
<p><img class="alignnone size-full wp-image-195" title="Maven - Welcome to Apache Maven-1" src="../../wp-content/uploads/2009/09/Maven-Welcome-to-Apache-Maven-1.png" alt="Maven - Welcome to Apache Maven-1" width="401" height="119" /></p>
<p>In <a href="http://www.outbrain.com/">outbrain</a> we decided we want to replace good old <a href="http://ant.apache.org/">ant</a> with maven.</p>
<p>Changing the company wide used build tool is not a decision taken lightly and may have consequences on product release cycle, but we weighted our options and decided to go for it, so I thought it might be worth mentioning our endeavor.</p>
<p>Everyone familiar with Java programming has probably used ant or at least heard of it. For many years it has been the de-facto standard build tool with large and growing audience, numerous plugins, excellent documentation and IDE support (for example most Java IDEs can automatically generate ant build files). But ant has its shortcomings which we, at outbrain decided we just couldn&#8217;t live with. We found maven to fill up most of the gaps.</p>
<h2>How do ant and maven differ?</h2>
<p>Maven is newer and was built from scratch with many of the lessons learned by ant in mind. Both projects are written and maintained by the high quality, high standard <a href="http://www.apache.org/">apache software foundation</a>, home of many other wonderful open source products. Both ant and maven are still actively developed and maintained, so it would not be fair to say that maven replaces ant, though many developers tend to think so (including myself).</p>
<p>Ant and maven differ in many ways, but at least to me these are the winning points that actually make the difference and made choose maven:</p>
<h3>Maven is declarative. Ant is imperative.</h3>
<p>Here&#8217;s what an ant build file looks like for a simple java project:</p>

<div class="wp_syntax"><div class="code"><pre class="xml" style="font-family:monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;project</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;MyProject&quot;</span> <span style="color: #000066;">default</span>=<span style="color: #ff0000;">&quot;dist&quot;</span> <span style="color: #000066;">basedir</span>=<span style="color: #ff0000;">&quot;.&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;description<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
    simple example build file
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/description<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #808080; font-style: italic;">&lt;!-- set global properties for this build --&gt;</span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;src&quot;</span> <span style="color: #000066;">location</span>=<span style="color: #ff0000;">&quot;src&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;build&quot;</span> <span style="color: #000066;">location</span>=<span style="color: #ff0000;">&quot;build&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;property</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;dist&quot;</span>  <span style="color: #000066;">location</span>=<span style="color: #ff0000;">&quot;dist&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;target</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;init&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #808080; font-style: italic;">&lt;!-- Create the time stamp --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;tstamp</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
    <span style="color: #808080; font-style: italic;">&lt;!-- Create the build directory structure used by compile --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;mkdir</span> <span style="color: #000066;">dir</span>=<span style="color: #ff0000;">&quot;${build}&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/target<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;target</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;compile&quot;</span> <span style="color: #000066;">depends</span>=<span style="color: #ff0000;">&quot;init&quot;</span></span>
<span style="color: #009900;">    <span style="color: #000066;">description</span>=<span style="color: #ff0000;">&quot;compile the source &quot;</span> <span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #808080; font-style: italic;">&lt;!-- Compile the java code from ${src} into ${build} --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;javac</span> <span style="color: #000066;">srcdir</span>=<span style="color: #ff0000;">&quot;${src}&quot;</span> <span style="color: #000066;">destdir</span>=<span style="color: #ff0000;">&quot;${build}&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/target<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;target</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;dist&quot;</span> <span style="color: #000066;">depends</span>=<span style="color: #ff0000;">&quot;compile&quot;</span></span>
<span style="color: #009900;">    <span style="color: #000066;">description</span>=<span style="color: #ff0000;">&quot;generate the distribution&quot;</span> <span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #808080; font-style: italic;">&lt;!-- Create the distribution directory --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;mkdir</span> <span style="color: #000066;">dir</span>=<span style="color: #ff0000;">&quot;${dist}/lib&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
&nbsp;
    <span style="color: #808080; font-style: italic;">&lt;!-- Put everything in ${build} into the MyProject-${DSTAMP}.jar file --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;jar</span> <span style="color: #000066;">jarfile</span>=<span style="color: #ff0000;">&quot;${dist}/lib/MyProject-${DSTAMP}.jar&quot;</span> <span style="color: #000066;">basedir</span>=<span style="color: #ff0000;">&quot;${build}&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/target<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&nbsp;
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;target</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;clean&quot;</span></span>
<span style="color: #009900;">    <span style="color: #000066;">description</span>=<span style="color: #ff0000;">&quot;clean up&quot;</span> <span style="color: #000000; font-weight: bold;">&gt;</span></span>
    <span style="color: #808080; font-style: italic;">&lt;!-- Delete the ${build} and ${dist} directory trees --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;delete</span> <span style="color: #000066;">dir</span>=<span style="color: #ff0000;">&quot;${build}&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;delete</span> <span style="color: #000066;">dir</span>=<span style="color: #ff0000;">&quot;${dist}&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/target<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/project<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></div></div>

<p>And here&#8217;s the maven one:</p>

<div class="wp_syntax"><div class="code"><pre class="xml" style="font-family:monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;project</span> <span style="color: #000066;">xmlns</span>=<span style="color: #ff0000;">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span style="color: #000066;">xmlns:xsi</span>=<span style="color: #ff0000;">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span style="color: #009900;">  <span style="color: #000066;">xsi:schemaLocation</span>=<span style="color: #ff0000;">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;modelVersion<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>4.0.0<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/modelVersion<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>MyProject<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>MyProject<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/name<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;description<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>simple example build file<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/description<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;packaging<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>jar<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/packaging<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/project<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></div></div>

<p>Ant line count: <strong>22</strong> (not including spaces, comments)</p>
<p>Maven line count: <strong>7</strong>. (and they are real easy ones)</p>
<p>Short is good, especially in software (except perl <img src='../../wp-includes/images/smilies/icon_wink.gif' alt=';-)' class='wp-smiley' /> ). But except for the fact that mvn has shorter build files, there is something more important hidden here &#8211; declarative v.s. imperative.</p>
<p>With ant you have to tell it HOW to build. You have to tell it that it first needs to collect all java sources, then run the javac compiler on them, then collect all classes, then run the jar tool on them to make them a jar. That&#8217;s tedious, especially if you have to do it 30 times, for each and every project. In outbrain we have many projects so when we used ant you&#8217;d see the exact same ant code patterns again and again (including the mistakes, which survived copy-paste horror). Ant is hard to maintain and is also hard to write. Did any of the readers ever write an ant build file? I doubt that. I&#8217;ve been using ant for more than 5 years and never have I written a file from scratch. It&#8217;s always used to be either copy-paste or using the IDE support for automatic generation. This is a bad sign of superfluous language.</p>
<p>Maven is declarative. You don&#8217;t have to tell it HOW to build, only WHAT to build, so conceptually it&#8217;s a higher level build tool. With mvn you only have to say &#8220;Look, this is how I call my project and I want you to make a jar from it&#8221; that&#8217;s all, mvn will figure out the rest. It knows where to find the sources (convention) and it knows what steps it needs to take in oder to create a jar. It will compile your source files, will package all resources for you in that jar, will run tests and create that jar for you. You can intervene with this process, but you don&#8217;t have to. You can make jars, wars, ears and more.</p>
<p>Declarative is in many cases preferred over imperative. Think HTML vs. Java. HTML is declarative, Java is imperative. In HTML you say &lt;b&gt;bold&lt;/b&gt; which tells the browser you want the text to be bold. You don&#8217;t tell it how to make the text bold (e.g. how many pixels, what position etc) only that you want it bold and let the browser figure out how to handle it. In Java you&#8217;d have to tell it how to make the text bold, how to space the characters, how to space words around it, how to break lines etc. Declarative is in many cases a lot easier than imperative, you worry less.</p>
<p>Maven is declarative, you only have to say &#8220;this is my project, jar it&#8221;. With ant you have more control over what the build tool does, so you can go crazy with build scripts and&#8230; well&#8230; jar before compile, or clean after jar (instead of before it) or package the test code inside production code or whatever, you get the point, you have the freedom to err. 9 times out of 10 you don&#8217;t need the level of flexibility provided by ant and you&#8217;d be much safer using mvn.</p>
<h3>Dependency management.</h3>
<p>This is a big thing. That was actually the main reason I wanted to move out of ant. Maven has a wonderful dependency management system built in by default. Ant has nothing built in, although it has <a href="http://ant.apache.org/ivy/">ivy</a> as a plugin.</p>
<p>What is dependency management? There are external and internal dependencies. External dependencies are ones you download from the net, usually open source projects such as <a href="http://lucene.apache.org/">Lucene</a>, <a href="http://activemq.apache.org/">ActvieMQ</a>, and other open source projects. With maven you only have to declare your dependency on them and they get automatically downloaded. Example:</p>

<div class="wp_syntax"><div class="code"><pre class="xml" style="font-family:monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;dependency<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>struts<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/groupId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>struts-bean<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/artifactId<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>1.2.8<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/version<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/dependency<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre></div></div>

<div>With ant you basically have two options. One is download the library yourself and throw it in some folder, call it 3rdParty and add it to the classpath (good luck with keeping track of versioning, who&#8217;s using what and your life) or use ivy, which is pretty decent, but as mentioned before not part of the default ant installation.</div>
<div>As for internal dependencies, which means your project which depends (uses) another one of your projects, mvn supports that as well. AFAIK ant does not. With ant, if you have more than one project in your company (and of course you do), you&#8217;d have to manually tweak the build scripts so they run in the correct order and dependencies are compiled before they are used. Although it&#8217;s possible, that&#8217;s sort of nightmarish as companies grows.</div>
<div>Dependency management is a killer feature for mvn and was actually the main reason that prompted me to pursue it. Although ant can have ivy, this was not zero-work, so I decided, heck it we&#8217;re going to put some work into it, let&#8217;s rebuild the whole thing and get a much better result. So we did.</div>
<div></div>
<h3>Conventions vs. configuration</h3>
<p>Conventions are good. They save a lot of time and prevent you from doing foolish mistakes (such as packaging test code into production).</p>
<p>By conventions I mean:</p>
<ul>
<li>Where is the source code?</li>
<li>Where is the test code?</li>
<li>Where are the resources?</li>
<li>Where are the web files?</li>
<li>etc</li>
</ul>
<p>With ant you had to create a directory for sources (call it src or Src or source or srce) and tell and where your sources are. Then you&#8217;d have to decide where to put your tests. You can push them in tst, test, tests, or even in the same source directory as production code is, maybe in a test package. Next you have to <strong>configure</strong> ant where to find test code, how to separate it from production code, and heck &#8211; how to run it (it really doesn&#8217;t know how to do it).</p>
<p>With mvn that&#8217;s much easier. Maven promotes conventions such as the <a href="http://maven.apache.org/guides/introduction/introduction-to-the-standard-directory-layout.html">standard directory layout</a> which means all sources are at predefined location, all resources are as well etc. There are several advantages to that including that it&#8217;s easy to start a new project, you don&#8217;t have to think where everything goes, it&#8217;s hard to make mistakes by misplacing items, you don&#8217;t have to think about the build script and how to configure it and perhaps most important of all, you make all company employees conform to the same layout. That&#8217;s a huge gain for the company.</p>
<h3>Built-in functionality out of the box</h3>
<p>OK, there are plenty of other benefits to mvn but the post is already getting too long so let&#8217;s have the last one here.</p>
<p>With mvn you get tons of functionality out of the box. By creating a very simple build file with only the project definition in it you can:</p>
<ul>
<li>compile all sources</li>
<li>compile test</li>
<li>run unit tests</li>
<li>run integration tests</li>
<li>package as a jar/war or something else</li>
<li>deploy</li>
<li>run in tomcat</li>
<li>&#8230;and much more</li>
</ul>
<p>With ant what you had to do is for each one of the above listed goals, create an ant goal and configure ant by telling it how to run it. Some of them may be relatively trivial (but still require coding) and some of them aren&#8217;t easy at all&#8230; that kind of tells you why anters are very good with their CTRL+C and CTRL+V. And with copy-paste comes the pain of silly copy paste errors and difficult maintainability. Life with mvn is better <img src='../../wp-includes/images/smilies/icon_wink.gif' alt=';-)' class='wp-smiley' /> </p>
<p>Other great and not covered features: Eclipse and other IDE integration (automatically generating projects), great testing and debugging tools, excellent build output, excellent versioning and more.</p>
<h3>How did it go?</h3>
<p>So, how did it go? You guys have converted your entire codebase build tool. Isn&#8217;t that like <a href="http://www.joelonsoftware.com/articles/fog0000000069.html">Netscape&#8217;s near death experience</a> while rewriting their entire code base?</p>
<p>Well&#8230; no! The nice thing about mvn is that it&#8217;s easy to write and easy to learn. We did spend a couple of weeks on that task and had to resolve some unpredictable situations, but it had only a small impact on our schedule (and needless to say that I hope in the long term will have  the most positive impact on release schedule). Heck, we (at least I) even enjoyed it!</p>
<h3>Conclusions</h3>
<p>I&#8217;d definitely recommend mvn. If you&#8217;re starting a new project, choose mvn. If you have an existing codebase using ant and you&#8217;re thinking about moving to maven, know that it&#8217;s certainly feasible and in my opinion, well worth the effort. Expect some work, it&#8217;s not zero effort, but I promise you&#8217;ll enjoy it.</p>
<script type='text/javascript'>
		<!--
		//OBSTART:do_NOT_remove_this_comment
		var OutbrainPermaLink="../../2009/09/20/mavenizing-our-code-base/index.html";
		if(typeof(OB_Script)!='undefined'){OutbrainStart();} else {
		var OB_PlugInVer="7.0.0.0_Regular";;var OB_raterMode="stars";var OB_recMode="rec";var OBITm="1263219542";var OB_Script=true;var OB_langJS="";document.write(unescape("%3Cscript src='http://widgets.outbrain.com/OutbrainRater.js' type='text/javascript'%3E%3C/script%3E"));}
		//OBEND:do_NOT_remove_this_comment
		//-->
		</script>
		              </div>
      <!-- <p class="postmetadata2">Published in <a href="http://prettyprint.me/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a> -->
      <!-- by <php the_author(); ?> , September 20th, 2009 --> 
      <br />
      	</p></p>
    </div>
      <div class="post" id="post-166">
      <h1><a href="../../2009/08/28/experimenting-with-seam-carving/index.html" rel="bookmark" title="Permalink to Experimenting with Seam Carving">Experimenting with Seam Carving</a></h1>
      <p class="postmetadata">August 28th, 2009 | <a href="../../2009/08/28/experimenting-with-seam-carving/index.html#comments" title="Comment on Experimenting with Seam Carving">1 Comment &#187;</a></p>
      
      <div class="entry">
        <div class="tweetmeme_button" style="float: right; margin-left: 10px;"><a class="tm_button" rel="&amp;style=normal&amp;b=2" href="../../2009/08/28/experimenting-with-seam-carving/index.html"></a></div>
<p><a href="http://www.seamcarving.com/">Seam Carving</a> is a technique for smart image resizing developed by <a href="http://en.wikipedia.org/wiki/Shai_Avidan">Shai Avidan</a> and <a href="http://en.wikipedia.org/wiki/Ariel_Shamir">Ariel Shamir</a>. It&#8217;s cool. It&#8217;s really cool actually! It let&#8217;s you resize an image without having to lose important information, so for example, if there&#8217;s a face in the photo and a background, the background will shrink while the face will maintain its size. There are plenty of examples on the web and some very cool videos, so let&#8217;s have a taste of them first.<br />
<object width="425" height="344" data="http://www.youtube.com/v/vIFCV2spKtg&amp;hl=en&amp;fs=1&amp;" type="application/x-shockwave-flash"><param name="allowFullScreen" value="true" /><param name="allowscriptaccess" value="always" /><param name="src" value="http://www.youtube.com/v/vIFCV2spKtg&amp;hl=en&amp;fs=1&amp;" /><param name="allowfullscreen" value="true" /></object></p>
<p>There is also a large number of implementations and in many different languages, including <a href="http://www.semanticmetadata.net/2007/09/20/content-based-image-resizing-update-to-v2/">Java</a>, <a href="http://code.google.com/p/seam-carving-gui/">C++</a>, <a href="http://labs.pimsworld.org/2009/05/a-javascript-implementation-of-the-content-aware-image-resizing-algorithm/">JavaScript</a> and more.</p>
<p>Yesterday I wanted to integrate this cool technology into one of the outbrain features I&#8217;m working on, so here&#8217;s what I&#8217;ve learned:</p>
<p>First of all, it&#8217;s really cool, did I mention this? <img src='../../wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> .</p>
<p>I used a Java implementation by Mathias Lux from <a href="http://code.google.com/p/java-imageseams/">here</a> (thanks, Mathias). In general, this is a very nice work and I only had to fix but a few bugs to get it going <img src='../../wp-includes/images/smilies/icon_wink.gif' alt=';)' class='wp-smiley' /> .</p>
<p>When I first started using it I noticed two problems:</p>
<p>1. It&#8217;s slow. Any I mean &#8211; painfully slow! nothing that production code can live with. An average photo would get resized in about 30-60 seconds. No go, no good, no no no.</p>
<p>2. It doesn&#8217;t always do the right thing&#8230; I mean sometimes the result of the resize is sort of lame&#8230; Let&#8217;s have a look at some examples.</p>
<p>Before:</p>
<div id="attachment_171" class="wp-caption aligncenter" style="width: 307px"><img class="size-full wp-image-171 " title="Before carving" src="../../wp-content/uploads/2009/08/3.png" alt="Before carving" width="297" height="222" /><p class="wp-caption-text">Before carving</p></div>
<p>After:</p>
<div id="attachment_172" class="wp-caption aligncenter" style="width: 188px"><img class="size-full wp-image-172" title="After carving" src="../../wp-content/uploads/2009/08/3_carved.png" alt="After carving" width="178" height="100" /><p class="wp-caption-text">After carving</p></div>
<p>Hmm, that&#8217;s not so good, right?&#8230; See how that poor man&#8217;s face is distorted?</p>
<p>Here&#8217;s another one. Before:</p>
<div id="attachment_173" class="wp-caption aligncenter" style="width: 410px"><img class="size-full wp-image-173" title="Before Carving" src="../../wp-content/uploads/2009/08/2.jpg" alt="Before Carving" width="400" height="266" /><p class="wp-caption-text">Before Carving</p></div>
<p>And after carving. Notice the building roof&#8230; it seems to have endured a little earthquake&#8230;</p>
<div id="attachment_174" class="wp-caption aligncenter" style="width: 188px"><img class="size-full wp-image-174" title="After carving" src="../../wp-content/uploads/2009/08/2_carved.png" alt="After carving" width="178" height="100" /><p class="wp-caption-text">After carving</p></div>
<p>So, you see, I had a problem&#8230; The algorithm was correct, no problem with that, but perhaps this was not the best solution to what I was trying to achieve&#8230; What was my goal then? My goal was to have all images resized to the same size (in this case 178&#215;100) without having to letterbox or crop them. But I don&#8217;t mind so much that a face in the photo gets smaller, that&#8217;s perfectly OK by me, as long as the face doesn&#8217;t get but in the middle.</p>
<p>My solution:</p>
<p>Here&#8217;s what I did &#8211; Instead of using the seam carver right from the beginning, first I resized the image using a simple linear resize operation such that the photo would exactly match one of either the width or the height of the target photo, and only then did I run the seam carver.</p>
<p>For example, if the original size of the image was 300&#215;300 and I wanted the target size to be  100&#215;50 I first resized it to 100&#215;100 (so the image fills the entire width, and overflows the height) and only then use the seam carver to reduce its height.</p>
<p>The results were amazingly well! Performance dropped to about 500ms per photo (still, I can do better, but this is already a big improvement and can go to production) and most importantly, the photos look good now. Compare the following two resized and carved photos with the initial results.</p>
<div id="attachment_176" class="wp-caption aligncenter" style="width: 188px"><img class="size-full wp-image-176" title="Improved resized" src="../../wp-content/uploads/2009/08/resized3.png" alt="Improved resized" width="178" height="100" /><p class="wp-caption-text">Improved resized</p></div>
<div id="attachment_175" class="wp-caption aligncenter" style="width: 188px"><img class="size-full wp-image-175" title="Improved resized" src="../../wp-content/uploads/2009/08/resized2jpg.png" alt="Improved resized" width="178" height="100" /><p class="wp-caption-text">Improved resized</p></div>
<p>That did the trick, nice <img src='../../wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> .</p>
<script type='text/javascript'>
		<!--
		//OBSTART:do_NOT_remove_this_comment
		var OutbrainPermaLink="../../2009/08/28/experimenting-with-seam-carving/index.html";
		if(typeof(OB_Script)!='undefined'){OutbrainStart();} else {
		var OB_PlugInVer="7.0.0.0_Regular";;var OB_raterMode="stars";var OB_recMode="rec";var OBITm="1263219542";var OB_Script=true;var OB_langJS="";document.write(unescape("%3Cscript src='http://widgets.outbrain.com/OutbrainRater.js' type='text/javascript'%3E%3C/script%3E"));}
		//OBEND:do_NOT_remove_this_comment
		//-->
		</script>
		              </div>
      <!-- <p class="postmetadata2">Published in <a href="http://prettyprint.me/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a> -->
      <!-- by <php the_author(); ?> , August 28th, 2009 --> 
      <br />
      	</p></p>
    </div>
      <div class="post" id="post-123">
      <h1><a href="../../2009/08/01/why-functional-languages-rock-with-multi-core/index.html" rel="bookmark" title="Permalink to Why functional languages rock with multi-core">Why functional languages rock with multi-core</a></h1>
      <p class="postmetadata">August 1st, 2009 | <a href="../../2009/08/01/why-functional-languages-rock-with-multi-core/index.html#comments" title="Comment on Why functional languages rock with multi-core">8 Comments &#187;</a></p>
      
      <div class="entry">
        <div class="tweetmeme_button" style="float: right; margin-left: 10px;"><a class="tm_button" rel="&amp;style=normal&amp;b=2" href="../../2009/08/01/why-functional-languages-rock-with-multi-core/index.html"></a></div>
<p><img class="alignright size-thumbnail wp-image-161" title="intel_quadcore" src="../../wp-content/uploads/2009/08/intel_quadcore-150x150.jpg" alt="intel_quadcore" width="150" height="150" />Cores are cheaper nowadays. Almost all new computers are shipped with 2 or more cores. Datacenter computers usually ship with more &#8211; 4, 8, 32&#8230; Again the hardware industry has left the software industry behind; if only <a href="http://en.wikipedia.org/wiki/Moore's_law">Moore&#8217;s law</a> would work the same way for software&#8230;</p>
<p>But there is hope!</p>
<p><a href="http://en.wikipedia.org/wiki/Functional_programming">Functional programming languages</a> used to be a niche for the small group of programing languages advocates or emacs fanatics <img src='../../wp-includes/images/smilies/icon_wink.gif' alt=';-)' class='wp-smiley' />  I, for one, studied functional languages such as <a href="http://en.wikipedia.org/wiki/Lisp_(programming_language)">Lisp</a> and <a href="http://en.wikipedia.org/wiki/ML_(programming_language)">ML</a> at school but have never thought I&#8217;d ever use them in &#8220;real life&#8221; industry.</p>
<p>Things have started to change and in my opinion this is greatly due to the multi-core / huge datacenter / cloud computing shift in the software industry. The software industry has come to realize a few key points:</p>
<ul>
<li> One core can not handle the load, no matter how strong and fast is this core is. In the old days of <a href="http://www.research.ibm.com/deepblue/">IBM deep blue</a> and the super-computer age there was hope that with the advance of hardware industry cores would get infinitely stronger and every other day there would be another contestant on the fastest/stronger/capable core of the day. However, in the last 10 or so years we have come to realize that hardware has its limitations and clock-rate is one of them. The cores, at least as far as we can tell today, can not grow infinitely and we need a different solution. The solution is multi-core CPUs. The challenge to the software industry is taking the right advantage over the multi-core business. It used to be easy when programming for a single core &#8211; you only had to come up with an O(good) algorithm and leave the real time issues to the hands of the hardware guys. But with multiple cores programmers (and not the hardware guys) need to take responsibility over utilizing theh cores;  and that&#8217;s hard. Increasing CPU clock-rate is just not going to do, we&#8217;ve decided to go for the multi-core solution.</li>
<li>Cloud computing. Cloud computing is here to stay. I won&#8217;t talk  about the user added value of cloud computing, you can find <a href="http://www.google.com/search?q=cloud+computing">plenty of this in other media</a>, but what I will talk about is the new challenges it creates for programmers. There are quite a few new challenges, most of them are about scale, such as scaling your database, scaling your users sessions etc, but one of the most significant challenges is scaling your algorithm by parallelizing  it. When dealing with multiple cores the way to scale your algorithm is to make it run in parallel &#8211; and this is hard; this is truly hard. One of the challenges in parallelizing the algorithm is synchronizing effectively over state. Java and other modern programming languages have created built-in constructs to assist in program synchronization, such as the <em>synchronized</em> block. This gives you the possibility to take advantage of multiple threads running on multiple cores of the same CPU, but it has two downsides &#8211; one, is that it doesn&#8217;t yet let you take advantage of multiple CPU datacenter and two, is that it&#8217;s very hard to program without creating botttlenecks. In many cases what you&#8217;d see is over-synchronization which results bottlenecks, poor performance in execution (not to mention the actual cost of the JVM going into the synchronized block itself) and at the end of the day, you might actually run your program faster if it was single threaded. The problem, just to make it clear, is that current imperative languages, such as Java and C++ all keep <strong>state</strong>. The state is in their variables. The thing is that when you want two or more threads to access the same variable, or the same state (and modify it) you need to synchronize them; Creating correct sycnronization is hard and many times results in bottlenecks.</li>
</ul>
<p>Just to make that clear, when I say Multi-Core I mean two things actually: multiple cores on the same CPU, e.g. the same physical machine as well as multiple CPUs (machines) running in a datacenter.</p>
<p>Here&#8217;s where functional languages come to our rescue: They don&#8217;t keep state! Pure functional languages only present functions, which are pure computation and never keep state. Even in the not-so-pure functional languages, such as Scala, where the language does keep state, still programmers are encouraged not to use it and are given the correct constructs to use it less and use more pure functions which do not modify state (and simply return value) instead. Now, when you don&#8217;t keep state, you don&#8217;t need to synchronize state (there is always a bit of synchronization needed, but it lets you keep it to the minimum). Functional languages presnt pure-computation, a stateless computation; when computation is stateless it&#8217;s easy to run it in parallel on different parts of your data.</p>
<p>Now, I&#8217;m not saying it&#8217;s impossible to run parallel computations in imperative languages, that&#8217;s obviously not true, what I am saying that it&#8217;s hard, it&#8217;s very hard. In functional languages its easier.</p>
<p>It&#8217;s not surprise therefore that recently several functional (or semi-functional) languages have given rise, such as <a href="http://www.scala-lang.org/">Scala</a> and <a href="http://erlang.org/">Erlang</a>, as well as functional-like programming models for other imperative languages, such as Google&#8217;s <a href="http://en.wikipedia.org/wiki/MapReduce">Map-Reduce</a>.</p>
<p>Now let&#8217;s put things in a historical context. Imperative programming languages such as C++ and Java is what&#8217;s currently driving the software industry. I think this is about to change. Both imperative and functional languages have co-existed for a long time, but it appears that the imperative family of languages have had the lead for the past 30 years or so and why is that? Performance, that&#8217;s why! On single cores there&#8217;s nothing like good-old C to run a fast program. You may agree or disagree on how &#8220;pretty&#8221; the program is, but you can not disagree that performance-wise the imperatives win, and performance is what counts, it allows for superb user experience, nice new and complex, computation intensive features etc. But history is moving fast and things have started to change. Today what&#8217;s becoming more and more mainstream is cloud computing and its massive amounts of data and computation. It used to be the case that programs were written for client side installation and clients used to be single-core with growing clock-rate. Now two things have happened simultaneously &#8211; one is that increasing CPU clock-rate has its limits, so the hardware industry is going towards the multiple core business, and two is that as networks become faster and with higher availability cloud computing has given the rise and it presents us with new challenges of massive amounts of data and massive amounts of users. With these two in place and with the realization that it&#8217;s very hard to utilize imperative languages for writing parallel programs the software industry has started its shift towards functional languages.</p>
<p>In the future increased parallelism, rather than clock rate, will be the driving force in computing and for this task functional languages are in the best position to take the lead.</p>
<p><img class="alignleft size-full wp-image-162" title="functional-programming-joke" src="../../wp-content/uploads/2009/08/functional-programming-joke.png" alt="functional-programming-joke" width="500" height="375" /></p>
<script type='text/javascript'>
		<!--
		//OBSTART:do_NOT_remove_this_comment
		var OutbrainPermaLink="../../2009/08/01/why-functional-languages-rock-with-multi-core/index.html";
		if(typeof(OB_Script)!='undefined'){OutbrainStart();} else {
		var OB_PlugInVer="7.0.0.0_Regular";;var OB_raterMode="stars";var OB_recMode="rec";var OBITm="1263219542";var OB_Script=true;var OB_langJS="";document.write(unescape("%3Cscript src='http://widgets.outbrain.com/OutbrainRater.js' type='text/javascript'%3E%3C/script%3E"));}
		//OBEND:do_NOT_remove_this_comment
		//-->
		</script>
		              </div>
      <!-- <p class="postmetadata2">Published in <a href="http://prettyprint.me/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a> -->
      <!-- by <php the_author(); ?> , August 1st, 2009 --> 
      <br />
      	</p></p>
    </div>
      <div class="post" id="post-154">
      <h1><a href="../../2009/06/24/beware-of-the-singleton/index.html" rel="bookmark" title="Permalink to Beware of the Singleton">Beware of the Singleton</a></h1>
      <p class="postmetadata">June 24th, 2009 | <a href="../../2009/06/24/beware-of-the-singleton/index.html#comments" title="Comment on Beware of the Singleton">5 Comments &#187;</a></p>
      
      <div class="entry">
        <div class="tweetmeme_button" style="float: right; margin-left: 10px;"><a class="tm_button" rel="&amp;style=normal&amp;b=2" href="../../2009/06/24/beware-of-the-singleton/index.html"></a></div>
<p>The <a href="http://en.wikipedia.org/wiki/Singleton_pattern">Singleton design pattern</a> is well known and used among programmers. <strong>It is so easy to use that unfortunately it often gets misused</strong>.</p>
<p><img class="alignnone size-thumbnail wp-image-158" title="java-singleton-design-pattern" src="../../wp-content/uploads/2009/06/java-singleton-design-pattern-150x150.png" alt="java-singleton-design-pattern" width="186" height="152" /></p>
<p>In Java a singleton usually looks like this:</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:monospace;"> <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">class</span> Singleton <span style="color: #009900;">&#123;</span>
   <span style="color: #000000; font-weight: bold;">private</span> <span style="color: #000000; font-weight: bold;">static</span> <span style="color: #000000; font-weight: bold;">final</span> Singleton INSTANCE <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> Singleton<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
   <span style="color: #666666; font-style: italic;">// Private constructor prevents instantiation from other classes</span>
   <span style="color: #000000; font-weight: bold;">private</span> Singleton<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span><span style="color: #009900;">&#125;</span>
   <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000000; font-weight: bold;">static</span> Singleton getInstance<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
      <span style="color: #000000; font-weight: bold;">return</span> INSTANCE<span style="color: #339933;">;</span>
   <span style="color: #009900;">&#125;</span>
 <span style="color: #009900;">&#125;</span></pre></div></div>

<p>A singleton is used, as its name implies, to make sure that only one such instance of the class exists in the application. For example &#8220;the database singleton&#8221; or &#8220;the universe&#8221;. Many application define their domain such that there are single object of various kinds and the singleton design pattern programatically enforces that. Very cool, very useful.</p>
<p>But there&#8217;s another side to that story. Singletons are great in making sure there is only one instance of a class, but as a side effect they also make it very easy to access that object from anywhere. If you need access to the database singleton simply type Database.getInstance(). It&#8217;s just too easy that it gets misused!</p>
<p>We&#8217;ve all learned C and we all know that <strong>C global variable</strong><strong>s</strong> are bad. <strong>C global variables </strong><strong>are bad because they prevent encapsulation</strong>. When programming to C global variables it&#8217;s very hard to determine the environment or the context of the current executing code because this code depends on several globals that you&#8217;re not aware of and that could change it&#8217;s behavior. Suppose you want to call a function and its documentation says something like &#8220;before calling this function make sure to set gNum to 5, and depending on the value of gVersion the function will do this and that&#8230;&#8221; &#8211; that is, if you&#8217;re lucky you&#8217;ll have documentation to read&#8230; in some cases you have no docs at all and you&#8217;re left to either read the code or guess what global vars it uses. If I were to read such code I&#8217;d do everything that&#8217;s in my power not to use it.</p>
<p>So guess what? S<strong>ingletons == C Global variables</strong>. They are easily accessed from anywhere in the code and so easy to define and use that they get misused just like poor global vars in C do.</p>
<p>But there&#8217;s another reason why Singletons are bad. They make unit-testing very hard; in some cases even impossible to do proper unit-testing.</p>
<p>This is a key point. Suppose you have an application that uses a database and you want to unit-test it.</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">class</span> DataBean <span style="color: #009900;">&#123;</span>
 <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">String</span> getValue<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
  <span style="color: #000000; font-weight: bold;">return</span> Database.<span style="color: #006633;">getValue</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// The Database singleton</span>
 <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
...
@Test
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> testGetValue<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
 DataBean bean <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> DataBean<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
 assertEquals<span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">5</span>, bean.<span style="color: #006633;">getValue</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>When running a unit-test you don&#8217;t want to actually connect to a real database! You really don&#8217;t want to do that! There are several reasons why, just to name a few, you want fast execution, you don&#8217;t want to test the database, you only want to test the DataBean class, you don&#8217;t want to have to prepare and clean up the database with every test you run, you don&#8217;t want other ppl executing code to mess up your database, you don&#8217;t want failing tests to leave your database in an undefined state etc.</p>
<p>Using singletons is exceptionally bad for unit-testing. As a side note, when writing integration tests (or system-tests) you do want to test all system component, not just single elements, so in that case you do want to use a real database however unit-tests are far more important and effective and you should start with them and test single elements only.</p>
<p>So what&#8217;s the alternative then? <a href="http://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>. Make your data bean depend on the database and accept a database in its constructor (or in a setter for that matter). A related design patter is <a href="http://www.artima.com/lejava/articles/designprinciples.html">Program to Interfaces</a>, not to implementation.</p>

<div class="wp_syntax"><div class="code"><pre class="java" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">class</span> DataBean <span style="color: #009900;">&#123;</span>
<span style="color: #000000; font-weight: bold;">private</span> DatabaseInterface database<span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// A reference to a DB interface</span>
<span style="color: #000000; font-weight: bold;">public</span> DataBean<span style="color: #009900;">&#40;</span>DatabaseInterface d<span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
 database <span style="color: #339933;">=</span> d<span style="color: #339933;">;</span> <span style="color: #666666; font-style: italic;">// Store the DB</span>
 <span style="color: #000000; font-weight: bold;">public</span> <span style="color: #003399;">String</span> getValue<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
  <span style="color: #000000; font-weight: bold;">return</span> database.<span style="color: #006633;">getValue</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
 <span style="color: #009900;">&#125;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
...
@Test
<span style="color: #000000; font-weight: bold;">public</span> <span style="color: #000066; font-weight: bold;">void</span> testGetValue<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
 <span style="color: #666666; font-style: italic;">// Use a mock DB implementation for testing</span>
 DataBean bean <span style="color: #339933;">=</span> <span style="color: #000000; font-weight: bold;">new</span> DataBean<span style="color: #009900;">&#40;</span><span style="color: #000000; font-weight: bold;">new</span> MockDatabaseImplementation<span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
 assertEquals<span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">5</span>, bean.<span style="color: #006633;">getValue</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre></div></div>

<p>Conclusion: Singletons are effective making sure there&#8217;s only one of them in the application. They are hazardous because that make it too easy to use the global-variables anti-design pattern. Beware of them!</p>
<script type='text/javascript'>
		<!--
		//OBSTART:do_NOT_remove_this_comment
		var OutbrainPermaLink="../../2009/06/24/beware-of-the-singleton/index.html";
		if(typeof(OB_Script)!='undefined'){OutbrainStart();} else {
		var OB_PlugInVer="7.0.0.0_Regular";;var OB_raterMode="stars";var OB_recMode="rec";var OBITm="1263219542";var OB_Script=true;var OB_langJS="";document.write(unescape("%3Cscript src='http://widgets.outbrain.com/OutbrainRater.js' type='text/javascript'%3E%3C/script%3E"));}
		//OBEND:do_NOT_remove_this_comment
		//-->
		</script>
		              </div>
      <!-- <p class="postmetadata2">Published in <a href="http://prettyprint.me/category/uncategorized/" title="View all posts in Uncategorized" rel="category tag">Uncategorized</a> -->
      <!-- by <php the_author(); ?> , June 24th, 2009 --> 
      <br />
      	</p></p>
    </div>
    
  <div class="navigation">
    <div class="alignleft"><a href="../3/index.html" >&laquo; Previous Entries</a></div>
    <div class="alignright"><a href="../../index.html" >Next Entries &raquo;</a></div>
  </div>
  
 
 
</div><!-- //content -->

<div id="sidebar"><!-- sidebar -->

<p class="rssfeed"><a class="rsslink" href="../../feed/index.html"></a>
<p><a href="http://feeds2.feedburner.com/PrettyPrintMe"><img src="http://feeds2.feedburner.com/~fc/PrettyPrintMe?bg=3069B0&amp;fg=fffdfa&amp;anim=1" height="26" width="88" style="border:0" alt="" /></a></p>
</p>

<h2>Search</h2>
<form method="get" id="searchform" class="search" action="http://prettyprint.me/">
<input type="text" name="s" value="Type keywords and hit enter..." onfocus="if (this.value == 'Type keywords and hit enter...') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Type keywords and hit enter...';}" />
</form>

<!--
<h2>Categories</h2>
<ul>
		<li class="cat-item cat-item-1"><a href="http://prettyprint.me/category/uncategorized/" title="View all posts filed under Uncategorized">Uncategorized</a>
</li>
</ul>
-->

<h2>Blog Archives</h2>
<ul>
  	<li><a href='../../2011/07/index.html' title='July 2011'>July 2011</a></li>
	<li><a href='../../2011/02/index.html' title='February 2011'>February 2011</a></li>
	<li><a href='../../2011/01/index.html' title='January 2011'>January 2011</a></li>
	<li><a href='../../2010/08/index.html' title='August 2010'>August 2010</a></li>
	<li><a href='../../2010/05/index.html' title='May 2010'>May 2010</a></li>
	<li><a href='../../2010/04/index.html' title='April 2010'>April 2010</a></li>
	<li><a href='../../2010/03/index.html' title='March 2010'>March 2010</a></li>
	<li><a href='../../2010/02/index.html' title='February 2010'>February 2010</a></li>
	<li><a href='../../2010/01/index.html' title='January 2010'>January 2010</a></li>
	<li><a href='../../2009/11/index.html' title='November 2009'>November 2009</a></li>
	<li><a href='../../2009/10/index.html' title='October 2009'>October 2009</a></li>
	<li><a href='../../2009/09/index.html' title='September 2009'>September 2009</a></li>
	<li><a href='../../2009/08/index.html' title='August 2009'>August 2009</a></li>
	<li><a href='../../2009/06/index.html' title='June 2009'>June 2009</a></li>
	<li><a href='../../2009/05/index.html' title='May 2009'>May 2009</a></li>
</ul>

<!--
<h2>Links</h2>
<ul>
  <li><a href="http://wordpress.org/development/">Development Blog</a></li>
<li><a href="http://codex.wordpress.org/">Documentation</a></li>
<li><a href="http://wordpress.org/extend/plugins/">Plugins</a></li>
<li><a href="http://wordpress.org/extend/ideas/">Suggest Ideas</a></li>
<li><a href="http://wordpress.org/support/">Support Forum</a></li>
<li><a href="http://wordpress.org/extend/themes/">Themes</a></li>
<li><a href="http://planet.wordpress.org/">WordPress Planet</a></li>
</ul>
-->

<!--
<h2>Meta</h2>
<ul>
    <li><a href="http://prettyprint.me/wp-login.php">Log in</a></li>
  <li><a href="http://www.wordpress.org/">WordPress</a></li>
    <li><a href="http://validator.w3.org/check?uri=referer">XHTML</a></li>
</ul>
-->

 


</div> <!--//sidebar  -->

</div><!--//container-->

<div id="footer-container">
	
<div id="footer">

<div id="footerleft">
		<h2>About</h2>
  <p>Restrospective focuses on clean typography and modern colors and design.</p>
  </div>

<div id="footermid">
		<h2>Profiles, Links</h2>
	<ul>
  	<li><a href="http://www.linkedin.com/in/rantav">LinkedIn</a></li>
  	<li><a href="http://tavory.com/">Homepage</a></li>
  	<li><a href="http://twitter.com/rantav">Twitter</a></li>
  	<li><a href="http://reversim.com/">(Hebrew podcast I run) רברס עם פלטפורמה</a></li>
  	<li><a href="http://friendfeed.com/rantav">FriendFeed</a></li>
  	<li><a href="http://gbsheli.com/">Google Blog Sheli (my older blog, mostly Hebrew)</a></li>
  	<li><a href="http://www.facebook.com/people/Ran-Tavory/543122173">Facebook</a></li>
  </ul>
  </div>

<div id="footerright">
	<!--
	<h2>Recent Readers</h2>
-->
  <!--	Paste JavaScript from MyBlogLog or other services -->

  </div>

</div><!--//footer-->

<div class="copyright">
	Copyright &copy; <a href="../../index.html">PrettyPrint.me</a> &middot; All rights reserved.<br />
	
	Powered by <a href="http://wordpress.org/">WordPress</a> and <a href="http://blogbuildingu.com/retrospective">Retrospective theme</a> &middot; Design & code by <a href="http://blogbuildingu.com/">Hendry Lee</a>.

<script type='text/javascript' src='../../wp-content/plugins/contact-form-7/jquery.formd20f.js?ver=2.52'></script>
<script type='text/javascript' src='../../wp-content/plugins/contact-form-7/scripts747d.js?ver=2.4.5'></script>
<script src="../../wp-content/plugins/tweetmeme/button.js" type="text/javascript"></script></div>

</div><!--//footer-container-->

</body>

<!-- Mirrored from prettyprint.me/page/2/ by HTTrack Website Copier/3.x [XR&CO'2010], Fri, 28 Dec 2012 23:01:43 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
</html>
